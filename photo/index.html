<!DOCTYPE html>
<html lang="en" data-font="default" data-fontsize="medium">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="media/favicon.png">
<title>Val's Photofolio</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=Atkinson+Hyperlegible:wght@400;700&display=swap');

  @font-face {
    font-family: 'OpenDyslexic';
    src: url('fonts/OpenDyslexic-Regular.otf') format('opentype');
    font-weight: 400;
    font-style: normal;
  }

  :root {
    --font-default: 'Cormorant Garamond', serif;
    --font-atkinson: 'Atkinson Hyperlegible', sans-serif;
    --font-dyslexic: 'OpenDyslexic', sans-serif;
    --font-active: var(--font-default);
    --size-scale: 1;
  }
  [data-font="atkinson"] { --font-active: var(--font-atkinson); }
  [data-font="dyslexic"] { --font-active: var(--font-dyslexic); }
  [data-fontsize="small"] { --size-scale: 0.8; }
  [data-fontsize="large"] { --size-scale: 1.25; }
  [data-font="default"] { --size-scale: 1.1; }
  [data-font="default"][data-fontsize="small"] { --size-scale: 0.88; }
  [data-font="default"][data-fontsize="large"] { --size-scale: 1.375; }
  [data-font="dyslexic"] { --size-scale: 0.8; }
  [data-font="dyslexic"][data-fontsize="small"] { --size-scale: 0.64; }
  [data-font="dyslexic"][data-fontsize="large"] { --size-scale: 1; }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  html {
    height: 100%;
    overflow-y: scroll;
    scrollbar-width: none;
    background: rgb(118,118,118);
  }
  html::-webkit-scrollbar { display: none; }

  body {
    margin: 0;
    font-family: var(--font-active);
    background: rgb(118,118,118);
    color: rgba(255,255,255,0.9);
  }

  /* ══════ LOADER ══════ */
  #loader {
    position: fixed; inset: 0; z-index: 100;
    background: rgb(118,118,118);
    display: flex; align-items: center; justify-content: center;
    transition: opacity 0.8s ease, visibility 0.8s ease;
  }
  #loader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
  #loader .pulse {
    width: 0.52rem; height: 0.52rem;
    background: #fff; border-radius: 50%;
    animation: pulse 1.4s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.2; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.5); }
  }

  /* ══════ SLIDES ══════ */
  .slide {
    position: relative;
    width: 100%; height: 100dvh;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    background: rgb(118,118,118);
  }
  .slide.ending-slide {
    background: rgb(118,118,118);
  }
  .slide img.main-photo {
    position: absolute;
    object-fit: contain;
    opacity: 0;
    border-radius: 0.16rem;
    transition: opacity 0.6s ease;
  }
  .slide img.main-photo.loaded { opacity: 1; }
  .slide img.main-photo.expand {
    border-radius: 0;
    transition: width 5s cubic-bezier(0.22, 1, 0.36, 1),
                height 5s cubic-bezier(0.22, 1, 0.36, 1),
                border-radius 5s ease,
                opacity 0.6s ease;
  }
  .slide .vignette {
    position: absolute; inset: 0;
    pointer-events: none;
    background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.3) 100%);
    z-index: 2; opacity: 0;
    transition: opacity 0.5s ease 0.2s;
  }
  .slide.active .vignette { opacity: 1; }

  /* ══════ VIEW MORE BUTTON (ending slide) ══════ */
  .view-more-btn {
    position: relative;
    z-index: 10;
    padding: 1rem 2.5rem;
    font-family: var(--font-active);
    font-size: calc(0.9rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.2em;
    text-transform: none;
    color: rgba(255,255,255,0.9);
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0.4rem;
    cursor: pointer;
    transition: all 0.3s ease, opacity 0.5s ease;
    user-select: none;
  }
  .view-more-btn:hover {
    background: rgba(0, 0, 0, 0.6);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.05);
  }

  /* ══════ HERO SLIDE ══════ */
  .hero-grid {
    position: absolute; inset: 0;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 2px;
  }
  .hero-grid img {
    width: 100%; height: 100%;
    object-fit: cover;
    filter: grayscale(1);
    opacity: 0;
    animation: gridIn 0.15s ease forwards;
  }
  @keyframes gridIn {
    to { opacity: 1; }
  }
  .hero-overlay {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 3;
  }
  .hero-text {
    position: absolute; z-index: 5;
    text-align: center;
    user-select: none;
  }
  .hero-text h1 {
    font-family: var(--font-active);
    font-size: calc(4rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.3em;
    text-transform: none;
    color: #fff;
    margin-bottom: 0.4rem;
  }
  .hero-text p {
    font-family: var(--font-active);
    font-size: calc(0.8rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.2em;
    text-transform: none;
    color: rgba(255,255,255,0.5);
  }

  /* ══════ PHOTO INFO (bottom left) ══════ */
  .photo-info {
    position: absolute;
    bottom: 1.5rem; left: 1.65rem;
    z-index: 10;
    font-size: calc(0.6rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.12em;
    line-height: 1.5;
    color: rgba(255,255,255,0.9);
    opacity: 0;
    transition: opacity 0.6s ease 0.4s;
    user-select: none;
    text-transform: none;
  }
  .slide.active .photo-info { opacity: 1; }
  .photo-info .info-line {
    display: flex; align-items: center; gap: 0.3rem;
    white-space: nowrap;
    cursor: default;
    position: relative;
  }
  .photo-info .info-line.hoverable { cursor: default; }
  .photo-info .info-line .extra-text { display: none; }
  .photo-info .info-line.hovered .extra-text { display: inline; }
  .photo-info .hover-photo {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 0.4rem;
    width: 6rem;
    height: 6rem;
    border-radius: 0.4rem;
    object-fit: contain;
    background: rgba(15,15,15,0.6);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.3);
    padding: 0.4rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    display: none;
  }
  .photo-info .hover-photo.show { display: block; opacity: 1; }

  /* ══════ AUTO-HIDE UI ══════ */
  .ui-element {
    transition: opacity 0.5s ease;
  }
  .ui-element.hidden {
    opacity: 0 !important;
    pointer-events: none;
  }

  /* ══════ CENTER DESCRIPTION ══════ */
  .photo-description {
    position: absolute;
    top: 88%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 15;
    max-width: 600px;
    padding: 1rem 2rem;
    text-align: center;
    font-size: calc(0.8rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.1em;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.9);
    opacity: 0;
    transition: opacity 0.5s ease;
    user-select: none;
    pointer-events: none;
  }
  .slide.active .photo-description {
    opacity: 1;
    pointer-events: auto;
  }
  .photo-description:hover {
    opacity: 1 !important;
  }

  /* ══════ COUNTER (top left) ══════ */
  #counter {
    position: fixed; top: 1.45rem; left: 1.65rem; z-index: 50;
    font-size: calc(0.85rem * var(--size-scale)); font-weight: 300;
    letter-spacing: 0.15em;
    color: rgba(255,255,255,0.9); user-select: none;
    transition: opacity 0.4s ease;
    min-width: 3rem; /* Prevent layout shift */
  }
  #counter:empty {
    opacity: 0 !important;
    pointer-events: none;
  }
  #counter.hero-page {
    opacity: 0 !important;
    pointer-events: none;
  }
  
  /* Per-slide counter (for continuous scroll mode) */
  .slide-counter {
    position: absolute; top: 1.45rem; left: 1.65rem; z-index: 10;
    font-size: calc(0.85rem * var(--size-scale)); font-weight: 300;
    letter-spacing: 0.15em;
    color: rgba(255,255,255,0.9); user-select: none;
    opacity: 0; /* Hidden by default */
    transition: opacity 0.4s ease;
  }

  /* ══════ LEATHER TAB (top center) ══════ */
  #leather-tab {
    position: fixed; top: 0; left: 50%; transform: translateX(-50%);
    z-index: 200;
    padding: 0.45rem 1.4rem 0.5rem;
    background:
      repeating-linear-gradient(45deg, transparent, transparent 1px, rgba(0,0,0,0.04) 1px, rgba(0,0,0,0.04) 2px),
      repeating-linear-gradient(-45deg, transparent, transparent 1px, rgba(0,0,0,0.04) 1px, rgba(0,0,0,0.04) 2px),
      linear-gradient(180deg, #8a6235, #6b4423, #5a3618);
    border-radius: 0 0 0.5rem 0.5rem;
    cursor: pointer;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    user-select: none;
    transition: opacity 0.5s ease, box-shadow 0.3s ease;
  }
  #leather-tab:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.7); }
  #leather-tab::after {
    content: '';
    position: absolute;
    left: 0.2rem; right: 0.2rem; bottom: 0.2rem; top: 0;
    border: 1.5px dashed rgba(255,255,255,0.18);
    border-top: none;
    border-radius: 0 0 0.4rem 0.4rem;
    pointer-events: none;
  }
  #leather-tab .tab-title {
    font-size: calc(0.7rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.25em;
    text-transform: none;
    color: #fff;
  }
  #leather-tab .tab-sub {
    font-size: calc(0.4rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.15em;
    text-transform: none;
    color: rgba(255,255,255,0.4);
    margin-top: 0.05rem;
  }

  /* Search bar */
  #search-bar-container {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 199;
    width: 500px;
    max-width: 90vw;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, top 0.3s ease;
  }
  #search-bar-container.visible {
    opacity: 1;
    pointer-events: all;
  }
  
  /* Category buttons below search bar */
  #category-buttons {
    display: flex;
    gap: 2.5rem;
    justify-content: center;
    margin-top: 1rem;
    padding: 0 1rem;
  }
  .category-btn {
    position: relative;
    width: 9rem;
    height: 4rem;
    background: rgba(20, 20, 20, 1) !important;
    cursor: pointer;
    flex-shrink: 0;
    overflow: visible;
    transition: none !important;
  }
  .category-btn:hover {
    background: rgba(20, 20, 20, 1) !important;
  }
  .category-btn.active {
    background: rgba(20, 20, 20, 1) !important;
  }
  .category-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -0.6rem;
    width: 1.2rem;
    height: 100%;
    background: rgba(20, 20, 20, 1) !important;
    border-radius: 50% 0 0 50%;
    transition: none !important;
  }
  .category-btn:hover::before,
  .category-btn.active::before {
    background: rgba(20, 20, 20, 1) !important;
  }
  .category-btn::after {
    content: '';
    position: absolute;
    top: 0;
    right: -0.6rem;
    width: 1.2rem;
    height: 100%;
    background: rgba(20, 20, 20, 1) !important;
    border-radius: 0 50% 50% 0;
    transition: none !important;
  }
  .category-btn:hover::after,
  .category-btn.active::after {
    background: rgba(20, 20, 20, 1) !important;
  }
  .category-extension {
    position: absolute;
    left: 50%;
    top: 100%;
    transform: translateX(-50%);
    width: 8.1rem;
    max-height: 0;
    background: rgba(20, 20, 20, 1);
    transition: max-height 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    overflow: hidden;
    z-index: 10;
    opacity: 1;
  }
  /* Extension expands when button is active AND menu is open */
  .category-btn.active .category-extension {
    max-height: 0;
  }
  #search-bar-container.visible .category-btn.active .category-extension {
    max-height: calc(100vh - 300px);
  }
  
  /* Single colored center strip for each can - ALWAYS VISIBLE */
  .category-btn-overlay {
    position: absolute;
    top: 0;
    left: 10%;
    right: 10%;
    height: 4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 1;
    opacity: 1 !important;
    transition: none !important;
  }
  
  /* Add elliptical ends to colored overlay - SAME SIZE as outer shell */
  .category-btn-overlay::before {
    content: '';
    position: absolute;
    top: 0;
    left: -0.6rem;
    width: 1.2rem;
    height: 100%;
    border-radius: 50% 0 0 50%;
    transition: none !important;
  }
  .category-btn-overlay::after {
    content: '';
    position: absolute;
    top: 0;
    right: -0.6rem;
    width: 1.2rem;
    height: 100%;
    border-radius: 0 50% 50% 0;
    transition: none !important;
  }
  
  /* Left can = Bright Blue - NEVER CHANGES */
  .category-btn[data-cat="main"] .category-btn-overlay {
    background: rgb(100, 150, 255) !important;
  }
  .category-btn[data-cat="main"] .category-btn-overlay::before,
  .category-btn[data-cat="main"] .category-btn-overlay::after {
    background: rgb(100, 150, 255) !important;
  }
  .category-btn[data-cat="main"]:hover .category-btn-overlay,
  .category-btn[data-cat="main"].active .category-btn-overlay {
    background: rgb(100, 150, 255) !important;
  }
  .category-btn[data-cat="main"]:hover .category-btn-overlay::before,
  .category-btn[data-cat="main"]:hover .category-btn-overlay::after,
  .category-btn[data-cat="main"].active .category-btn-overlay::before,
  .category-btn[data-cat="main"].active .category-btn-overlay::after {
    background: rgb(100, 150, 255) !important;
  }
  
  /* Middle can = Bright White - NEVER CHANGES */
  .category-btn[data-cat="portraits"] .category-btn-overlay {
    background: rgb(255, 255, 255) !important;
  }
  .category-btn[data-cat="portraits"] .category-btn-overlay::before,
  .category-btn[data-cat="portraits"] .category-btn-overlay::after {
    background: rgb(255, 255, 255) !important;
  }
  .category-btn[data-cat="portraits"]:hover .category-btn-overlay,
  .category-btn[data-cat="portraits"].active .category-btn-overlay {
    background: rgb(255, 255, 255) !important;
  }
  .category-btn[data-cat="portraits"]:hover .category-btn-overlay::before,
  .category-btn[data-cat="portraits"]:hover .category-btn-overlay::after,
  .category-btn[data-cat="portraits"].active .category-btn-overlay::before,
  .category-btn[data-cat="portraits"].active .category-btn-overlay::after {
    background: rgb(255, 255, 255) !important;
  }
  
  /* Right can = Bright Orange - NEVER CHANGES */
  .category-btn[data-cat="landscapes"] .category-btn-overlay {
    background: rgb(255, 150, 50) !important;
  }
  .category-btn[data-cat="landscapes"] .category-btn-overlay::before,
  .category-btn[data-cat="landscapes"] .category-btn-overlay::after {
    background: rgb(255, 150, 50) !important;
  }
  .category-btn[data-cat="landscapes"]:hover .category-btn-overlay,
  .category-btn[data-cat="landscapes"].active .category-btn-overlay {
    background: rgb(255, 150, 50) !important;
  }
  .category-btn[data-cat="landscapes"]:hover .category-btn-overlay::before,
  .category-btn[data-cat="landscapes"]:hover .category-btn-overlay::after,
  .category-btn[data-cat="landscapes"].active .category-btn-overlay::before,
  .category-btn[data-cat="landscapes"].active .category-btn-overlay::after {
    background: rgb(255, 150, 50) !important;
  }
  .film-panel {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  .film-panel.active {
    /* No max-height needed - parent extension controls this */
  }
  .film-content {
    display: flex; flex-direction: row;
    align-items: flex-start; gap: 0.4rem;
    flex: 1; min-height: 0; overflow: hidden;
    width: 100%;
  }
  
  .category-btn-label {
    font-family: var(--font-active);
    font-size: calc(0.6rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.15em;
    color: rgba(255, 255, 255, 0.9);
    text-transform: none;
    user-select: none;
    position: relative;
    z-index: 2;
  }
  
  /* Dark text on white can */
  .category-btn[data-cat="portraits"] .category-btn-label {
    color: rgba(0, 0, 0, 0.9);
  }
  
  .search-wrapper {
    position: relative;
  }
  #search-bar {
    width: 100%;
    background: rgba(30, 30, 30, 0.95);
    border: 2px solid rgba(150, 150, 150, 0.3);
    border-radius: 8px;
    padding: 12px 12px 12px 45px;
    font-family: var(--font-active);
    font-size: calc(14px * var(--size-scale));
    color: #fff;
    outline: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    transition: border-color 0.2s ease;
  }
  #search-bar:focus {
    border-color: rgba(200, 200, 200, 0.5);
  }
  #search-bar::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }
  #search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    opacity: 0.5;
    pointer-events: none;
  }
  #search-icon svg {
    width: 100%;
    height: 100%;
    stroke: #fff;
    fill: none;
    stroke-width: 2;
  }

  /* Search results dropdown */
  #search-results {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    right: 0;
    background: rgba(25, 25, 25, 0.98);
    border: 2px solid rgba(150, 150, 150, 0.3);
    border-radius: 8px;
    max-height: 70vh;
    overflow-y: auto;
    display: none;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
  }
  #search-results.visible {
    display: block;
  }
  #search-results::-webkit-scrollbar {
    width: 8px;
  }
  #search-results::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
  }
  #search-results::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }

  /* Tag categories */
  .tag-category {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  .tag-category:last-child {
    border-bottom: none;
  }
  .tag-category-title {
    font-size: calc(11px * var(--size-scale));
    color: rgba(255, 255, 255, 0.5);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 8px;
  }
  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .tag-item {
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    font-size: calc(12px * var(--size-scale));
    color: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
  }
  .tag-item:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
  }
  .tag-item.active {
    background: rgba(100, 150, 255, 0.3);
    border-color: rgba(100, 150, 255, 0.6);
  }
  .tag-count {
    opacity: 0.6;
    font-size: 0.9em;
    margin-left: 4px;
  }

  /* Thumbnail results */
  .search-thumbnails {
    padding: 12px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 8px;
  }
  .search-thumb {
    position: relative;
    aspect-ratio: 3/2;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  .search-thumb:hover {
    transform: scale(1.05);
  }
  .search-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .search-thumb-number {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
  }

  /* ══════ SETTINGS BUTTON (top right) ══════ */
  #settings-btn {
    position: fixed; top: 1.25rem; right: 1.35rem; z-index: 200;
    width: 1.6rem; height: 1.6rem;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  #settings-btn svg {
    width: 1.1rem; height: 1.1rem;
    stroke: rgba(255,255,255,0.9); stroke-width: 1.5; fill: none;
    stroke-linecap: round; stroke-linejoin: round;
    transition: transform 0.4s ease;
  }
  #settings-btn:hover svg { transform: rotate(30deg); }

  /* ══════ SOUND TOGGLE BUTTON (top right, next to settings) ══════ */
  #sound-btn {
    position: fixed; top: 1.25rem; right: 3.5rem; z-index: 200;
    width: 1.6rem; height: 1.6rem;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  #sound-btn svg {
    width: 1.1rem; height: 1.1rem;
    stroke: rgba(255,255,255,0.9); stroke-width: 1.5; fill: none;
    stroke-linecap: round; stroke-linejoin: round;
    transition: opacity 0.3s ease;
  }
  #sound-btn.muted svg {
    opacity: 0.4;
  }
  #sound-btn .sound-slash {
    stroke: rgba(255,255,255,0.9);
    stroke-width: 2;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  #sound-btn.muted .sound-slash {
    opacity: 1;
  }

  /* ══════ SETTINGS POPUP ══════ */
  #settings-popup {
    position: fixed;
    top: 3.5rem; right: 1.35rem;
    z-index: 201;
    background: rgba(15,15,15,0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 0.4rem;
    padding: 0.8rem 1rem;
    opacity: 0; pointer-events: none;
    transform: translateY(-0.3rem);
    transition: opacity 0.3s ease, transform 0.3s ease;
    min-width: 14rem;
    border: 1px solid rgba(255,255,255,0.08);
  }
  @media (max-width: 768px) {
    #settings-popup {
      right: 0.5rem;
      left: 0.5rem;
      min-width: 0;
      max-width: calc(100vw - 1rem);
    }
  }
  #settings-popup.open {
    opacity: 1; pointer-events: auto; transform: translateY(0);
  }
  .setting-row {
    margin-bottom: 0.55rem;
  }
  .setting-row:last-child { margin-bottom: 0; }
  .setting-label {
    display: block;
    font-size: calc(0.45rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.2em;
    text-transform: none;
    color: rgba(255,255,255,0.4);
    margin-bottom: 0.25rem;
  }
  .setting-options {
    display: flex; gap: 0.25rem; flex-wrap: wrap;
  }
  .setting-btn {
    font-family: var(--font-active);
    font-size: calc(0.42rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: none;
    color: rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 0.2rem;
    padding: 0.2rem 0.45rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .setting-btn:hover { color: #fff; border-color: rgba(255,255,255,0.3); }
  .setting-btn.active {
    color: #fff;
    background: rgba(255,255,255,0.12);
    border-color: rgba(255,255,255,0.4);
  }

  /* ══════ FILM OVERLAY ══════ */
  #film-overlay {
    position: fixed; inset: 0; z-index: 150;
    pointer-events: none; opacity: 0;
    transition: opacity 0.4s ease;
  }
  #film-overlay.open { pointer-events: auto; opacity: 1; }
  #film-overlay .backdrop {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.6);
  }
  /* ── Film canister ── */
  #film-canister {
    display: none; /* Hidden */
  }
  .canister-body {
    position: absolute;
    top: 1.2rem; bottom: 1.2rem;
    left: 1rem; right: 1rem;
    background: linear-gradient(90deg, #333, #222, #2a2a2a, #222, #333);
    border-left: 1px solid #444;
    border-right: 1px solid #444;
  }
  .canister-cap {
    position: absolute;
    left: 0; right: 0; height: 2.4rem;
    background: linear-gradient(180deg, #444, #2a2a2a);
    border-radius: 50%;
    border: 1px solid #555;
  }
  .canister-cap.top { top: 0; }
  .canister-cap.bottom { bottom: 0; background: linear-gradient(180deg, #2a2a2a, #444); }
  .canister-label {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.45rem;
    letter-spacing: 0.2em;
    text-transform: none;
    color: #555;
    white-space: nowrap;
    user-select: none;
  }

  #categories-strip {
    display: none; /* Hidden */
  }
  
  #film-strip {
    height: 100%;
    display: flex;
    flex-direction: column;
    width: 8.1rem; /* Match peek strip: sprockets (0.9) + padding (0.15) + frame (6) + padding (0.15) + sprockets (0.9) */
    flex-shrink: 0;
  }
  #film-strip .film-body, #categories-strip .film-body {
    flex: 1; min-height: 0;
  }
  .film-body {
    position: relative;
    background: #1a1a1a;
    display: flex; flex-direction: row;
    flex: 1; min-height: 0;
  }
  .sprockets {
    width: 0.9rem;
    display: flex; flex-direction: column;
    gap: 0.8rem; align-items: center;
    padding: 0; flex-shrink: 0;
  }
  .sprocket {
    width: 0.45rem; height: 0.3rem;
    border-radius: 0.06rem;
    background: #111;
    border: 1px solid #333;
    flex-shrink: 0;
  }
  .film-frames {
    display: flex; flex-direction: column;
    gap: 0.35rem; padding: 0 0.15rem;
    overflow-y: auto; scrollbar-width: none;
  }
  .film-frames::-webkit-scrollbar { display: none; }
  .film-frame {
    position: relative;
    cursor: pointer;
    border-radius: 0.08rem;
    overflow: hidden;
    opacity: 0.6;
    transition: opacity 0.3s ease, box-shadow 0.3s ease;
    box-shadow: inset 0 0 0 1px transparent;
    flex-shrink: 0;
  }
  .film-frame:hover { opacity: 1; }
  .film-frame.current { opacity: 1; box-shadow: inset 0 0 0 1px #fff; }
  .film-frame img {
    display: block; width: 6rem; height: 4rem; object-fit: cover;
  }
  .film-frame .frame-num {
    position: absolute;
    bottom: 0.15rem; right: 0.25rem;
    font-size: 0.5rem; font-weight: 300;
    letter-spacing: 0.08em; color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
  }
  .film-edge-text {
    font-size: 0.35rem; font-weight: 300;
    letter-spacing: 0.15em; text-transform: none;
    color: #444;
    writing-mode: vertical-rl; text-orientation: mixed;
    padding: 0.4rem 0.1rem; user-select: none;
    white-space: nowrap; display: flex; align-items: center;
  }
  .cat-frames {
    display: flex; flex-direction: column;
    gap: 0.35rem; padding: 0.5rem 0.15rem;
  }
  .cat-frame {
    width: 6rem; height: 4rem;
    background: #1e1e1e;
    box-shadow: inset 0 0 0 1px #333;
    border-radius: 0.08rem;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; opacity: 0.5;
    transition: opacity 0.3s ease, box-shadow 0.3s ease;
    flex-shrink: 0;
  }
  .cat-frame:hover { opacity: 0.8; }
  .cat-frame.active { opacity: 1; box-shadow: inset 0 0 0 1px #fff; }
  .cat-label {
    font-size: 0.6rem; font-weight: 300;
    letter-spacing: 0.2em; text-transform: none;
    color: #fff; user-select: none;
  }

  /* ══════ LOREM IPSUM WINDOW ══════ */
  #lorem-window {
    position: fixed;
    top: 5rem; left: 2rem;
    z-index: 152;
    width: 22rem;
    max-height: 60vh;
    background: rgba(15,15,15,0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 0.5rem;
    padding: 1.2rem 1.4rem;
    border: 1px solid rgba(255,255,255,0.08);
    opacity: 0; pointer-events: none;
    transform: translateY(0.5rem);
    transition: opacity 0.4s ease, transform 0.4s ease;
    overflow-y: auto;
  }
  @media (max-width: 768px) {
    #lorem-window {
      top: 140px;          /* Below search bar */
      left: 50%;
      transform: translateX(-50%) translateY(0.5rem);
      right: auto;
      width: 90vw;
      max-width: 500px;
      max-height: calc(100vh - 160px);
      padding: 1rem;
    }
    #lorem-window.open {
      transform: translateX(-50%) translateY(0);
    }
  }
  #lorem-window.open { opacity: 1; pointer-events: auto; transform: translateY(0); }
  #lorem-window h2 {
    font-size: calc(1rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.15em;
    margin-bottom: 0.6rem;
    color: rgba(255,255,255,0.8);
  }
  #lorem-window p {
    font-size: calc(0.52rem * var(--size-scale));
    font-weight: 300;
    line-height: 1.7;
    color: rgba(255,255,255,0.5);
    margin-bottom: 0.5rem;
  }

  /* ══════ RESIZE HINT + PREVIEW ══════ */
  #resize-group {
    position: fixed;
    bottom: 1.35rem; right: 1.35rem;
    z-index: 50;
    display: flex; flex-direction: column;
    align-items: flex-end; gap: 0.4rem;
    opacity: 0;
    transition: opacity 0.5s ease, transform 0.5s ease;
    transform: translateY(0.3rem);
    pointer-events: none;
  }
  #resize-group.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
  #resize-group .label {
    font-size: calc(0.6rem * var(--size-scale)); font-weight: 300;
    letter-spacing: 0.12em; text-transform: none;
    color: #fff;
    white-space: nowrap; user-select: none;
    text-align: right; line-height: 1.3;
  }

  /* Crop preview */
  #crop-preview {
    position: relative;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  #resize-group.show-preview #crop-preview {
    opacity: 1;
  }
  #crop-preview .photo-full {
    position: absolute;
    border-radius: 0.15rem;
    border: 1px solid #fff;
    overflow: hidden;
    background: #3a0a0a;
  }
  #crop-preview .photo-full img {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover; opacity: 0.25;
  }
  #crop-preview .viewport-crop {
    position: absolute;
    border-radius: 0.1rem;
    border: 1px solid #fff;
    overflow: hidden;
  }
  #crop-preview .viewport-crop img {
    position: absolute; object-fit: cover; opacity: 0.9;
  }
  #crop-preview .ratio-label {
    position: absolute;
    font-size: calc(0.5rem * var(--size-scale));
    font-weight: 300;
    letter-spacing: 0.12em;
    color: #fff; user-select: none; white-space: nowrap;
  }

  /* ══════ SCROLL INDICATOR ══════ */
  #scroll-down {
    position: fixed; bottom: 1.45rem; left: 50%;
    transform: translateX(-50%);
    z-index: 50;
    display: flex; flex-direction: column;
    align-items: center; gap: 0.3rem;
    opacity: 1;
    cursor: pointer;
    pointer-events: auto;
  }
  #scroll-down.hidden { opacity: 0; pointer-events: none; }
  #scroll-down span {
    font-size: calc(0.75rem * var(--size-scale)); font-weight: 300;
    letter-spacing: 0.2em; text-transform: none; color: rgba(255,255,255,0.9);
    transition: opacity 0.4s ease;
  }
  #scroll-down.scrolled span { opacity: 0; }
  #scroll-down.scroll-to-top span { opacity: 1; } /* Always visible on last slide */
  #scroll-down .chevron {
    width: 0.7rem; height: 0.7rem;
    stroke: rgba(255,255,255,0.9); stroke-width: 1.5; fill: none;
    stroke-linecap: round; stroke-linejoin: round;
    transition: transform 0.3s ease;
  }
  #scroll-down.scroll-to-top .chevron { transform: rotate(180deg); } /* Flip arrow up */

  /* ══════ PEEK FILM STRIP (right) ══════ */
  #peek-strip {
    position: fixed;
    right: 0; top: 0; bottom: 0;
    z-index: 49;
    width: 8.1rem; /* Match menu strips */
    transform: translateX(100%);
    transition: transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s ease;
    opacity: 0;
    pointer-events: none;
    cursor: default;
  }
  #peek-strip.visible {
    transform: translateX(75%);
    opacity: 0.6;
    pointer-events: auto;
  }
  #peek-strip.visible:hover {
    transform: translateX(10%);
    opacity: 1;
  }
  #film-overlay.open ~ #peek-strip {
    opacity: 0 !important;
    pointer-events: none !important;
  }
  #peek-strip .film-body {
    height: 100%;
  }
  #peek-strip .film-frames {
    overflow: hidden;
  }
</style>
</head>
<body>
<script>
  // Detect mobile device
  var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
    || ('ontouchstart' in window) 
    || (window.innerWidth <= 768);
  
  // Set base font size - different calculation for mobile
  if (isMobile) {
    // Mobile: fixed 20px for readable text
    document.documentElement.style.fontSize = '20px';
  } else {
    // Desktop: original calculation
    document.documentElement.style.fontSize = (screen.width / 100) + 'px';
  }
</script>

<div id="loader"><div class="pulse"></div></div>
<div id="slides-container"></div>

<div id="scroll-down" class="ui-element">
  <span>scroll</span>
  <svg class="chevron" viewBox="0 0 24 24"><polyline points="6,9 12,15 18,9"/></svg>
</div>

<div id="counter" class="ui-element">1 / 5</div>

<div id="leather-tab" class="ui-element">
  <div class="tab-title">Val's Photofolio</div>
  <div class="tab-sub">tap to open menu</div>
</div>

<!-- Search bar -->
<div id="search-bar-container">
  <div class="search-wrapper">
    <div id="search-icon">
      <svg viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
    </div>
    <input type="text" id="search-bar" placeholder="type to filter tags..." autocomplete="off" />
    
    <!-- Search results dropdown -->
    <div id="search-results"></div>
  </div>
  
  <!-- Category buttons -->
  <div id="category-buttons">
    <div class="category-btn active" data-cat="main">
      <div class="category-btn-overlay">
        <span class="category-btn-label">main</span>
      </div>
      <div class="category-extension">
        <!-- Main film strip inside extension -->
        <div class="film-panel" id="film-panel-main" data-cat="main">
          <div class="film-content">
            <div class="film-strip">
              <div class="film-body">
                <div class="sprockets"></div>
                <div class="film-frames"></div>
                <div class="sprockets"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="category-btn" data-cat="portraits">
      <div class="category-btn-overlay">
        <span class="category-btn-label">portraits</span>
      </div>
      <div class="category-extension">
        <!-- Portraits film strip inside extension -->
        <div class="film-panel" id="film-panel-portraits" data-cat="portraits">
          <div class="film-content">
            <div class="film-strip">
              <div class="film-body">
                <div class="sprockets"></div>
                <div class="film-frames"></div>
                <div class="sprockets"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="category-btn" data-cat="landscapes">
      <div class="category-btn-overlay">
        <span class="category-btn-label">landscapes</span>
      </div>
      <div class="category-extension">
        <!-- Landscapes film strip inside extension -->
        <div class="film-panel" id="film-panel-landscapes" data-cat="landscapes">
          <div class="film-content">
            <div class="film-strip">
              <div class="film-body">
                <div class="sprockets"></div>
                <div class="film-frames"></div>
                <div class="sprockets"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="sound-btn" class="ui-element">
  <svg viewBox="0 0 24 24">
    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
    <line class="sound-slash" x1="3" y1="3" x2="21" y2="21"/>
  </svg>
</div>

<div id="settings-btn" class="ui-element">
  <svg viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="3"/>
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
  </svg>
</div>

<div id="settings-popup">
  <div class="setting-row">
    <span class="setting-label">font</span>
    <div class="setting-options">
      <button class="setting-btn active" data-setting="font" data-val="default">cormorant garamond</button>
      <button class="setting-btn" data-setting="font" data-val="atkinson">atkinson</button>
      <button class="setting-btn" data-setting="font" data-val="dyslexic">opendyslexic</button>
    </div>
  </div>
  <div class="setting-row">
    <span class="setting-label">size</span>
    <div class="setting-options">
      <button class="setting-btn" data-setting="fontsize" data-val="small">small</button>
      <button class="setting-btn active" data-setting="fontsize" data-val="medium">medium</button>
      <button class="setting-btn" data-setting="fontsize" data-val="large">large</button>
    </div>
  </div>
  <div class="setting-row">
    <span class="setting-label">language</span>
    <div class="setting-options">
      <button class="setting-btn active" data-setting="lang" data-val="en">english</button>
      <button class="setting-btn" data-setting="lang" data-val="pt">portugu&#234;s</button>
    </div>
  </div>
  <div class="setting-row">
    <span class="setting-label">photo resolution</span>
    <div class="setting-options">
      <button class="setting-btn" data-setting="res" data-val="low">low</button>
      <button class="setting-btn active" data-setting="res" data-val="default">default</button>
      <button class="setting-btn" data-setting="res" data-val="high">high</button>
    </div>
  </div>
  <div class="setting-row">
    <span class="setting-label">snapping</span>
    <div class="setting-options">
      <button class="setting-btn active" data-setting="snapping" data-val="on">on</button>
      <button class="setting-btn" data-setting="snapping" data-val="off">off</button>
    </div>
  </div>
</div>

<!-- Film overlay -->
<div id="film-overlay">
  <div class="backdrop" id="film-backdrop"></div>
</div>

<div id="lorem-window">
  <h2>about</h2>
  <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
  <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
  <p>Curabitur pretium tincidunt lacus. Nulla gravida orci a odio. Nullam varius, turpis et commodo pharetra, est eros bibendum elit, nec luctus magna felis sollicitudin mauris.</p>
</div>

<div id="resize-group" class="ui-element">
  <div id="crop-preview">
    <div class="photo-full" id="photo-full"><img id="crop-img-dim" /></div>
    <div class="viewport-crop" id="viewport-crop"><img id="crop-img-bright" /></div>
    <span class="ratio-label" id="photo-ratio-label"></span>
  </div>
  <span class="label" id="hint-label"></span>
</div>

<!-- Peek strip (right) -->
<div id="peek-strip">
  <div class="film-body">
    <div class="sprockets" id="peek-sprockets-left"></div>
    <div class="film-frames" id="peek-frames"></div>
    <div class="sprockets" id="peek-sprockets-right"></div>
  </div>
</div>

<!-- Sound elements -->
<audio id="shutter-sound" preload="none"></audio>
<audio id="hover-sound" src="sounds/hover.wav" preload="auto"></audio>
<audio id="open-sound" src="sounds/open.ogg" preload="auto"></audio>
<audio id="close-sound" src="sounds/close.ogg" preload="auto"></audio>
<audio id="select-sound" src="sounds/select.wav" preload="auto"></audio>
<audio id="tap-sound" src="sounds/tap.wav" preload="auto"></audio>
</audio>

<!-- Load photo data from external file -->
<script src="data.js"></script>
<script>
  // Debug: Check if data loaded
  if (typeof categories === 'undefined' || !categories) {
    alert('ERROR: data.js failed to load! Make sure data.js is in the same folder as index.html');
  } else if (!categories.main || categories.main.length === 0) {
    alert('ERROR: No photos found in categories.main. Check data.js');
  }
</script>

<script>
(function() {
  /* ══════ DATA ══════ */
  // Photo data is now in data.js - edit that file to change your photos!
  // 
  // EXAMPLE STRUCTURE (for reference - actual data in data.js):
  // 
  // var lenses = {
  //   '7art_35_f095': {
  //     name: '35mm f/0.95',
  //     image: 'media/7artf095.png',
  //     extra: ' 35mm f/0.95 7artisans'
  //   }
  // };
  //
  // var cameras = {
  //   'a6400': {
  //     name: 'APS-C',
  //     image: 'media/a6400.png',
  //     extra: ' Sony a6400'
  //   }
  // };
  //
  // var categories = {
  //   main: [
  //     { 
  //       base: 'a1.jpg',                    // Just filename - auto-adds "photos/"
  //       lens: '7art_35_f095',              // Reference lens key (for hover image)
  //       camera: 'a6400',                   // Reference camera key
  //       stock: '',                         // Film stock (blank for digital)
  //       date: '2023-03-15',                // YYYY-MM-DD format
  //       focal: '35mm',                     // Focal length used
  //       aperture: 'f/8',                   // Aperture used
  //       iso: '100',                        // ISO used
  //       shutter: '1/50s',                  // Shutter speed used
  //       city: 'Lisbon',                    // Optional: City
  //       country: 'Portugal',               // Optional: Country
  //       subject: 'street photography',     // Optional: Subject/theme
  //       tags: ['urban', 'sunset', 'people'] // Optional: Search tags array
  //     },
  //   ],
  //   portraits: [ ... ],
  //   landscapes: [ ... ]
  // };
  //
  // var heroPhotoUrls = [
  //   'a1.jpg',         // Just filename - auto-adds "photos/" and "-small"
  //   'a2.jpg',
  // ];
  //
  // SEARCH INDEXES ALL FIELDS:
  // - base filename, focal, aperture, iso, shutter, stock, date
  // - lens name and brand, camera name and model
  // - city, country, subject, tags
  // Search is case-insensitive and matches partial text

  var currentRes = 'default'; // Kept for settings UI

  // Auto-add photos/ prefix and return full path
  function imgUrl(base, res) {
    return 'photos/' + base;
  }
  
  // Auto-generate thumbnail path: photo.jpg → photos/photo-small.jpg
  function thumbUrl(base) {
    var lastDot = base.lastIndexOf('.');
    var name = base.substring(0, lastDot);
    var ext = base.substring(lastDot);
    return 'photos/' + name + '-small' + ext;
  }

  /* ══════ DOM REFS ══════ */
  var loader = document.getElementById('loader');
  var slidesContainer = document.getElementById('slides-container');
  var counterEl = document.getElementById('counter');
  var scrollInd = document.getElementById('scroll-down');
  var leatherTab = document.getElementById('leather-tab');
  var tabSub = leatherTab.querySelector('.tab-sub');
  var settingsBtn = document.getElementById('settings-btn');
  var soundBtn = document.getElementById('sound-btn');
  var settingsPopup = document.getElementById('settings-popup');
  var filmOvl = document.getElementById('film-overlay');
  var filmBkdp = document.getElementById('film-backdrop');
  var filmPanelMain = document.getElementById('film-panel-main');
  var filmPanelPortraits = document.getElementById('film-panel-portraits');
  var filmPanelLandscapes = document.getElementById('film-panel-landscapes');
  var loremWindow = document.getElementById('lorem-window');
  var resizeGroup = document.getElementById('resize-group');
  var hintLabel = document.getElementById('hint-label');
  var cropPreview = document.getElementById('crop-preview');
  var photoFullEl = document.getElementById('photo-full');
  var vpCropEl = document.getElementById('viewport-crop');
  var cropDimImg = document.getElementById('crop-img-dim');
  var cropBrightImg = document.getElementById('crop-img-bright');
  var photoRatioLbl = document.getElementById('photo-ratio-label');
  var peekStrip = document.getElementById('peek-strip');
  var peekFrames = document.getElementById('peek-frames');
  var searchBarContainer = document.getElementById('search-bar-container');
  var searchBar = document.getElementById('search-bar');
  var searchResults = document.getElementById('search-results');

  // Sound elements
  var hoverSound = document.getElementById('hover-sound');
  var tapSound = document.getElementById('tap-sound');
  var openSound = document.getElementById('open-sound');
  var closeSound = document.getElementById('close-sound');
  var selectSound = document.getElementById('select-sound');
      /* ══════ STATE ══════ */
  var currentCat = 'main';
  var slides = [], slideImages = [], total = 0;
  var loadedCount = 0, firstLoaded = false, activeIndex = -1;
  var targetSlideIndex = -1; // Track where we're scrolling TO (for smooth scroll interruption)
  var filmMenuOpen = false;
  var hasHero = true;
  var sw = screen.width;
  var snappingEnabled = true; // Toggle for snapping behavior
  var soundsEnabled = true; // Toggle for sound effects

  /* ══════ SOUND HELPER ══════ */
  function playSound(audioElement) {
    if (!soundsEnabled) return;
    audioElement.currentTime = 0;
    audioElement.play().catch(function() {});
  }

  /* ══════ IMAGE SIZING ══════ */
  function containSize(nw, nh, bw, bh) {
    var s = Math.min(bw/nw, bh/nh);
    return { w: Math.round(nw*s), h: Math.round(nh*s) };
  }
  function coverSize(nw, nh, bw, bh) {
    var s = Math.max(bw/nw, bh/nh);
    return { w: Math.round(nw*s), h: Math.round(nh*s) };
  }
  function setSmall(img) {
    var nw = img.naturalWidth||3, nh = img.naturalHeight||2;
    var s = containSize(nw, nh, window.innerWidth*0.8, window.innerHeight*0.8);
    img.style.width = s.w+'px'; img.style.height = s.h+'px';
  }
  function setExpand(img) {
    var nw = img.naturalWidth||3, nh = img.naturalHeight||2;
    var s = coverSize(nw, nh, window.innerWidth, window.innerHeight);
    img.style.width = s.w+'px'; img.style.height = s.h+'px';
  }

  /* ══════ BUILD SLIDES ══════ */
  function buildSlides(catKey) {
    console.log('buildSlides called with:', catKey);
    console.log('categories:', categories);
    console.log('categories[catKey]:', categories[catKey]);
    
    currentCat = catKey;
    var photos = categories[catKey];
    
    if (!photos) {
      console.error('No photos found for category:', catKey);
      return;
    }
    
    console.log('Building', photos.length, 'slides for', catKey);
    
    var isMain = (catKey === 'main');
    activeIndex = -1; targetSlideIndex = -1; loadedCount = 0; firstLoaded = false;
    slidesContainer.innerHTML = '';
    loader.classList.remove('hidden');
    scrollInd.classList.remove('scrolled');
    window.scrollTo({ top: 0, behavior: 'auto' });

    // Hero slide only for main
    if (isMain) {
      var hero = document.createElement('div');
      hero.className = 'slide hero-slide';
      var grid = document.createElement('div');
      grid.className = 'hero-grid';
      for (var g = 0; g < 30; g++) {
        var gi = document.createElement('img');
        gi.src = thumbUrl(heroPhotoUrls[g % heroPhotoUrls.length]);
        gi.style.animationDelay = (g * 40) + 'ms';
        gi.alt = '';
        grid.appendChild(gi);
      }
      hero.appendChild(grid);
      var overlay = document.createElement('div');
      overlay.className = 'hero-overlay';
      hero.appendChild(overlay);
      var vig = document.createElement('div');
      vig.className = 'vignette';
      vig.style.opacity = '1';
      hero.appendChild(vig);
      var heroText = document.createElement('div');
      heroText.className = 'hero-text';
      heroText.innerHTML = '<h1>portfolio</h1><p>photography collection</p>';
      hero.appendChild(heroText);
      slidesContainer.appendChild(hero);
    }

// Photo slides
for (var i = 0; i < photos.length; i++) {
  var p = photos[i];
  var slide = document.createElement('div');
  slide.className = 'slide';
  
  var img = document.createElement('img');
  img.className = 'main-photo';
  img.src = imgUrl(p.base, currentRes);
  img.alt = p.base.replace('.jpg', '').replace('.png', ''); // Use filename as alt
  slide.appendChild(img);
  
  var v = document.createElement('div');
  v.className = 'vignette';
  slide.appendChild(v);

  // Photo info
  var info = document.createElement('div');
  info.className = 'photo-info ui-element';
  
  // Auto-generate thumbnail path
  var photoSrc = thumbUrl(p.base);
  
  // Get lens and camera data from definitions
  var lensData = lenses[p.lens] || { name: p.lens, image: 'media/f095.png', extra: '' };
  var cameraData = cameras[p.camera] || { name: p.camera, image: 'media/a6400.png', extra: '' };
  
  // Calculate EV (Exposure Value) from aperture and shutter speed
  function calculateEV(aperture, shutter) {
    if (!aperture || !shutter) return null;
    
    // Parse f-number: "f/8" -> 8
    var fNumber = parseFloat(aperture.replace('f/', ''));
    
    // Parse shutter speed: "1/50s" -> 0.02
    var shutterTime;
    if (shutter.includes('/')) {
      var parts = shutter.replace('s', '').split('/');
      shutterTime = parseFloat(parts[0]) / parseFloat(parts[1]);
    } else {
      shutterTime = parseFloat(shutter.replace('s', ''));
    }
    
    // EV = log2(N²/t)
    var ev = Math.log2((fNumber * fNumber) / shutterTime);
    return Math.round(ev * 10) / 10; // Round to 1 decimal
  }
  
  var evValue = calculateEV(p.aperture, p.shutter);
  
  // Build info lines (only show non-empty lines)
  var infoLines = '';
  
  // Line 1: Focal + Aperture OR Lens Name (with hover)
  var lensLineText = '';
  var lensHoverBase = '';
  
  if (p.focal && p.aperture) {
    // Both focal and aperture exist - show them
    lensLineText = p.focal + ' ' + p.aperture;
    lensHoverBase = lensLineText;
  } else if (p.focal || p.aperture) {
    // Only one exists - show what we have
    lensLineText = (p.focal || '') + (p.focal && p.aperture ? ' ' : '') + (p.aperture || '');
    lensHoverBase = lensLineText;
  } else if (p.lens && lensData.name) {
    // No focal/aperture, but lens key exists - show lens name
    lensLineText = lensData.name;
    lensHoverBase = lensData.name;
  }
  
  // Only add lens line if we have something to show
  if (lensLineText) {
    infoLines += '<div class="info-line hoverable" data-hover="lens" data-base="' + lensHoverBase + '" data-ext="' + lensData.extra + '">' + lensLineText + '<span class="extra-text"></span></div>';
  }
  
  // Line 2: Shutter speed + EV (only if shutter exists)
  if (p.shutter) {
    var shutterLine = p.shutter;
    // Only calculate and show EV if we have both aperture and shutter AND evValue is valid
    if (p.aperture && p.shutter && evValue !== null && !isNaN(evValue)) {
      shutterLine += ' EV' + evValue;
    }
    infoLines += '<div class="info-line">' + shutterLine + '</div>';
  }
  
  // Line 3: Camera (only if camera exists)
  if (p.camera && cameraData.name) {
    infoLines += '<div class="info-line hoverable" data-hover="sensor" data-base="' + cameraData.name + '" data-ext="' + cameraData.extra + '">' + cameraData.name + '<span class="extra-text"></span></div>';
  }
  
  // Line 4: Stock + ISO (only if ISO exists)
  if (p.iso) {
    var stockIsoLine = (p.stock ? p.stock + ' ' : '') + '@ ' + p.iso + ' ISO';
    infoLines += '<div class="info-line">' + stockIsoLine + '</div>';
  }
  
  // Line 4.5: Developing (only if developing exists) - NEW!
  if (p.developing) {
    infoLines += '<div class="info-line">Developing: ' + p.developing + '</div>';
  }
  
  // Line 5: Date (only if date exists and is valid)
  if (p.date) {
    var dateParts = p.date.split('-'); // ['2023', '03', '15'] or ['2021']
    var year = dateParts[0];
    if (year) {
      infoLines += '<div class="info-line date-line" data-year="' + year + '" data-full="' + p.date + '">' + year + '</div>';
    }
  }
  
  info.innerHTML =
    '<img class="hover-photo" src="' + lensData.image + '" data-for="lens" />' +
    '<img class="hover-photo" src="' + cameraData.image + '" data-for="sensor" />' +
    infoLines;
  
  slide.appendChild(info);
  
  // Photo description (centered) - NEW!
  if (p.description) {
    var desc = document.createElement('div');
    desc.className = 'photo-description ui-element';
    desc.textContent = p.description;
    slide.appendChild(desc);
  }
  
  // Per-slide counter (for continuous scroll mode)
  var slideCounter = document.createElement('div');
  slideCounter.className = 'slide-counter';
  var counterText = isMain ? (i + 1) + ' / ' + photos.length : (i + 1) + ' / ' + photos.length;
  slideCounter.textContent = counterText;
  slide.appendChild(slideCounter);
  
  slidesContainer.appendChild(slide);
}

    // Add ending slide after all photos
    var endingSlide = document.createElement('div');
    endingSlide.className = 'slide ending-slide';
    
    // Add vignette
    var endVig = document.createElement('div');
    endVig.className = 'vignette';
    endingSlide.appendChild(endVig);
    
    // Add centered "view more" button
    var viewMoreBtn = document.createElement('button');
    viewMoreBtn.className = 'view-more-btn ui-element';
    viewMoreBtn.textContent = 'view more';
    viewMoreBtn.addEventListener('click', function() {
      toggleFilmMenu();
    });
    viewMoreBtn.addEventListener('mouseenter', function() {
      playSound(hoverSound);
    });
    endingSlide.appendChild(viewMoreBtn);
    
    slidesContainer.appendChild(endingSlide);

    total = photos.length + (isMain ? 2 : 1); // +2 for main (hero + ending), +1 for others (ending)
    slides = slidesContainer.querySelectorAll('.slide');
    slideImages = slidesContainer.querySelectorAll('.slide img.main-photo');
    counterEl.textContent = '';

    // Setup hover on info lines
    setupInfoHovers();

    // Load handlers
    slideImages.forEach(function(img) {
      if (img.complete && img.naturalWidth > 0) onImgLoad(img);
      else {
        img.addEventListener('load', function() { onImgLoad(img); });
        img.addEventListener('error', function() { loadedCount++; if(!firstLoaded){firstLoaded=true;loader.classList.add('hidden');} });
      }
    });

    // Hero loads fast, just hide loader
    if (slideImages.length === 0) {
      loader.classList.add('hidden');
      firstLoaded = true;
    }
    setTimeout(function() {
      loader.classList.add('hidden');
      firstLoaded = true;
      scrollInd.classList.remove('scrolled');
      activateSlide(0);
    }, 500);

    buildFilmFrames(catKey);
    buildPeekFrames(catKey);
  }

  function onImgLoad(img) {
    setSmall(img);
    img.classList.add('loaded');
    loadedCount++;
    if (!firstLoaded) {
      firstLoaded = true;
      loader.classList.add('hidden');
      scrollInd.classList.remove('scrolled');
      updateRatio();
    }
  }

  /* ══════ ACTIVATE SLIDE ══════ */
  function activateSlide(idx) {
    if (idx === activeIndex) return;
    activeIndex = idx;
    targetSlideIndex = idx; // Keep target in sync with actual position
    var isMain = (currentCat === 'main');
    var isHero = isMain && (idx === 0);

    for (var i = 0; i < slides.length; i++) {
      var img = slides[i].querySelector('img.main-photo');
      if (!img) {
        // hero slide — toggle active class only
        slides[i].classList.toggle('active', i === idx);
        continue;
      }
      if (snappingEnabled) {
        // Normal snapping mode: expand active, shrink others
        if (i === idx) {
          img.classList.add('expand');
          setExpand(img);
          slides[i].classList.add('active');
        } else {
          img.classList.remove('expand');
          setSmall(img);
          slides[i].classList.remove('active');
        }
      } else {
        // Continuous scroll mode: all images stay expanded
        img.classList.add('expand');
        setExpand(img);
        slides[i].classList.add('active');
      }
    }

    // Counter visibility based on snapping mode
    if (snappingEnabled) {
      // Snapping ON: use fixed counter
      counterEl.style.opacity = '1';
      document.querySelectorAll('.slide-counter').forEach(function(c) { c.style.opacity = '0'; });
      
      var isEndingSlide = (idx === total - 1);
      
      // Update fixed counter text
      if (isHero || isEndingSlide) {
        counterEl.textContent = '';
        counterEl.classList.add('hero-page');
      } else {
        counterEl.classList.remove('hero-page');
        if (isMain) {
          counterEl.textContent = idx + ' / ' + (total - 2); // -2 to exclude hero and ending
        } else {
          counterEl.textContent = (idx + 1) + ' / ' + (total - 1); // +1 because idx starts at 0, -1 to exclude ending
        }
      }
    } else {
      // Snapping OFF: use per-slide counters
      counterEl.style.opacity = '0';
      counterEl.classList.remove('hero-page');
      document.querySelectorAll('.slide-counter').forEach(function(c) { c.style.opacity = '1'; });
    }

    // Resize group: hide on hero
    updateRatio();
    
    // Update scroll indicator
    var scrollIndSpan = scrollInd.querySelector('span');
    if (idx >= total - 1) {
      scrollInd.classList.add('scroll-to-top');
      scrollIndSpan.textContent = 'scroll to top';
    } else {
      scrollInd.classList.remove('scroll-to-top');
      scrollIndSpan.textContent = 'scroll';
    }

    if (filmMenuOpen) updateFilmHighlight();
    updatePeekHighlight();
  }

  /* ══════ SCROLL ══════ */
  var scrollTimer = null;
  function onScroll() {
    var st = document.documentElement.scrollTop || document.body.scrollTop;
    var vh = window.innerHeight;
    var nearest = Math.round(st / vh);
    nearest = Math.max(0, Math.min(nearest, total - 1));

    // Update peek highlight in real-time as user scrolls
    updatePeekHighlight(nearest);
    // Update film highlight too if menu is open
    if (filmMenuOpen) updateFilmHighlight(nearest);

    var isMain = (currentCat === 'main');
    var isEndingSlide = (nearest === total - 1);
    
    if ((isMain && nearest === 0) || isEndingSlide) {
      counterEl.textContent = '';
      counterEl.classList.add('hero-page');
    } else {
      counterEl.classList.remove('hero-page');
      if (isMain) counterEl.textContent = nearest + ' / ' + (total - 2); // -2 to exclude hero and ending
      else counterEl.textContent = (nearest + 1) + ' / ' + (total - 1); // +1 because nearest starts at 0, -1 to exclude ending
    }

    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(function() {
      var s = document.documentElement.scrollTop || document.body.scrollTop;
      var snapped = Math.round(s / vh);
      snapped = Math.max(0, Math.min(snapped, total - 1));
      activateSlide(snapped);
    }, 80);

    if (st > vh * 0.15) scrollInd.classList.add('scrolled');
    else scrollInd.classList.remove('scrolled');
    
    // Update scroll indicator based on position
    var scrollIndSpan = scrollInd.querySelector('span');
    if (nearest >= total - 1) {
      // On last slide - show "scroll to top" with up arrow
      scrollInd.classList.add('scroll-to-top');
      scrollIndSpan.textContent = 'scroll to top';
    } else {
      // Not on last slide - show "scroll" with down arrow
      scrollInd.classList.remove('scroll-to-top');
      scrollIndSpan.textContent = 'scroll';
    }
  }

  window.addEventListener('scroll', function() { requestAnimationFrame(onScroll); }, { passive: true });

  // Scroll indicator click → scroll to next slide or top if on last
  scrollInd.addEventListener('click', function() {
    // Play scroll sound
    playSound(hoverSound);
    
    var st = document.documentElement.scrollTop || document.body.scrollTop;
    var vh = window.innerHeight;
    var current = Math.round(st / vh);
    
    if (current >= total - 1) {
      // On last slide - scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
      // Not on last slide - scroll to next
      var next = Math.min(current + 1, total - 1);
      window.scrollTo({ top: vh * next, behavior: 'smooth' });
    }
  });

  window.addEventListener('resize', function() {
    for (var i = 0; i < slides.length; i++) {
      var img = slides[i].querySelector('img.main-photo');
      if (!img) continue;
      if (i === activeIndex) setExpand(img);
      else setSmall(img);
    }
    updateRatio();
  });

  /* ══════ FILM STRIP ══════ */
  function buildCatSprockets() {
    var el = ['cat-sprockets-left','cat-sprockets-right'];
    el.forEach(function(id) {
      var c = document.getElementById(id);
      if (!c) return; // Element doesn't exist - skip
      if (c.children.length > 0) return;
      for (var i = 0; i < 20; i++) {
        var s = document.createElement('div'); s.className = 'sprocket'; c.appendChild(s);
      }
    });
  }

  function fillSprockets(idOrElement, n) {
    var c = typeof idOrElement === 'string' ? document.getElementById(idOrElement) : idOrElement;
    if (!c) return;
    c.innerHTML = '';
    for (var i = 0; i < n; i++) {
      var s = document.createElement('div'); s.className = 'sprocket'; c.appendChild(s);
    }
  }

function buildFilmFrames(catKey) {
    // Get the correct film panel for this category
    var panelId = 'film-panel-' + catKey;
    var panel = document.getElementById(panelId);
    if (!panel) return;
    
    var filmFramesEl = panel.querySelector('.film-frames');
    var sprocketsLeft = panel.querySelectorAll('.sprockets')[0];
    var sprocketsRight = panel.querySelectorAll('.sprockets')[1];
    
    filmFramesEl.innerHTML = '';
    fillSprockets(sprocketsLeft, 40);
    fillSprockets(sprocketsRight, 40);
    var photos = categories[catKey];

    // Empty spacer at top for settings gear area (perfs but no frame)
    var spacer = document.createElement('div');
    spacer.style.height = '4.35rem'; // One frame pitch
    spacer.style.flexShrink = '0';
    filmFramesEl.appendChild(spacer);

    // Hero frame only for main
    if (catKey === 'main') {
      var hf = document.createElement('div'); hf.className = 'film-frame hero-thumb';
      var ht = document.createElement('img');
      ht.src = thumbUrl(heroPhotoUrls[1] || heroPhotoUrls[0]);
      ht.alt = 'hero';
      ht.style.filter = 'grayscale(1)';
      hf.appendChild(ht);
      var hn = document.createElement('span'); hn.className = 'frame-num';
      hn.textContent = '0'; hf.appendChild(hn);
      
      // Add hover sound
      hf.addEventListener('mouseenter', function() {
        playSound(hoverSound);
      });
      
      hf.addEventListener('click', function() {
        // Play click sound
        playSound(tapSound);
        
        // Switch to main if not already there
        if (currentCat !== 'main') {
          buildSlides('main');
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      filmFramesEl.appendChild(hf);
    }

    var heroOffset = (catKey === 'main') ? 1 : 0;
    for (var i = 0; i < photos.length; i++) {
      var f = document.createElement('div'); f.className = 'film-frame';
      var t = document.createElement('img');
      
      // Auto-generate thumbnail path
      t.src = thumbUrl(photos[i].base);
      
      t.alt = photos[i].base.replace('.jpg', '').replace('.png', '');
      f.appendChild(t);
      var n = document.createElement('span'); n.className = 'frame-num';
      n.textContent = (i+1); f.appendChild(n);
      f.setAttribute('data-index', i);
      
      // Add hover sound
      f.addEventListener('mouseenter', function() {
        playSound(hoverSound);
      });
      
      f.addEventListener('click', (function(idx, off, cat) {
        return function() {
          // Play click sound
          playSound(tapSound);
          
          // Switch to this category if not already there
          if (currentCat !== cat) {
            buildSlides(cat);
          }
          
          // Navigate to the photo
          window.scrollTo({ top: window.innerHeight * (idx + off), behavior: 'smooth' });
        };
      })(i, heroOffset, catKey));
      filmFramesEl.appendChild(f);
    }
    
    // Add ending frame
    var endFrame = document.createElement('div'); 
    endFrame.className = 'film-frame ending-frame';
    var endIcon = document.createElement('div');
    endIcon.style.cssText = 'width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: rgba(255,255,255,0.5);';
    endIcon.textContent = '→';
    endFrame.appendChild(endIcon);
    var endNum = document.createElement('span'); 
    endNum.className = 'frame-num';
    endNum.textContent = '→'; 
    endFrame.appendChild(endNum);
    
    // Add hover sound
    endFrame.addEventListener('mouseenter', function() {
      playSound(hoverSound);
    });
    
    endFrame.addEventListener('click', (function(cat) {
      return function() {
        // Play click sound
        playSound(tapSound);
        
        // Switch to this category if not already there
        if (currentCat !== cat) {
          buildSlides(cat);
        }
        
        // Scroll to ending slide
        var endingSlideIndex = categories[cat].length + (cat === 'main' ? 1 : 0);
        window.scrollTo({ top: window.innerHeight * endingSlideIndex, behavior: 'smooth' });
      };
    })(catKey));
    filmFramesEl.appendChild(endFrame);
    
    if (filmMenuOpen) updateFilmHighlight();
  }
  
  function updateFilmHighlight(idx) {
    // Get the film frames for the current category
    var panel = document.getElementById('film-panel-' + currentCat);
    if (!panel) return;
    var filmFramesEl = panel.querySelector('.film-frames');
    if (!filmFramesEl) return;
    
    var frames = filmFramesEl.querySelectorAll('.film-frame');
    var currentIdx = (idx !== undefined) ? idx : activeIndex;
    for (var i = 0; i < frames.length; i++) {
      frames[i].classList.toggle('current', i === currentIdx);
    }
  }

  /* ══════ PEEK STRIP ══════ */
function buildPeekFrames(catKey) {
    peekFrames.innerHTML = '';
    fillSprockets('peek-sprockets-left', 30);
    fillSprockets('peek-sprockets-right', 30);
    var photos = categories[catKey];
    var isMain = (catKey === 'main');

    // Empty spacer at top for settings gear area (perfs but no frame)
    var spacer = document.createElement('div');
    spacer.style.height = '4.35rem'; // One frame pitch
    spacer.style.flexShrink = '0';
    peekFrames.appendChild(spacer);

    // Frame 0: hero for main, back button for others
    var hf = document.createElement('div'); hf.className = 'film-frame hero-thumb';
    var ht = document.createElement('img');
    ht.src = isMain ? thumbUrl(heroPhotoUrls[0]) : 'media/back.jpg';
    ht.alt = isMain ? 'hero' : 'back to main';
    if (isMain) ht.style.filter = 'grayscale(1)';
    hf.appendChild(ht);
    var hn = document.createElement('span'); hn.className = 'frame-num';
    hn.textContent = '0'; hf.appendChild(hn);
    
    // Add hover sound
    hf.addEventListener('mouseenter', function() {
      playSound(hoverSound);
    });
    
    hf.addEventListener('click', function(e) {
      e.stopPropagation();
      // Play click sound
      playSound(tapSound);
      
      if (!isMain) {
        document.querySelectorAll('.cat-frame').forEach(function(c) { c.classList.remove('active'); });
        document.querySelector('.cat-frame[data-cat="main"]').classList.add('active');
        buildSlides('main');
      } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
    peekFrames.appendChild(hf);

    var heroOffset = isMain ? 1 : 0;
    for (var i = 0; i < photos.length; i++) {
      var f = document.createElement('div'); f.className = 'film-frame';
      var t = document.createElement('img');
      
      // Auto-generate thumbnail path
      t.src = thumbUrl(photos[i].base);
      
      t.alt = photos[i].base.replace('.jpg', '').replace('.png', '');
      f.appendChild(t);
      var n = document.createElement('span'); n.className = 'frame-num';
      n.textContent = (i+1); f.appendChild(n);
      
      // Add hover sound
      f.addEventListener('mouseenter', function() {
        playSound(hoverSound);
      });
      
      f.addEventListener('click', (function(idx, off) {
        return function(e) {
          e.stopPropagation();
          // Play click sound
          playSound(tapSound);
          window.scrollTo({ top: window.innerHeight * (idx + off), behavior: 'smooth' });
        };
      })(i, heroOffset));
      peekFrames.appendChild(f);
    }
    
    // Add ending frame
    var endFrame = document.createElement('div'); 
    endFrame.className = 'film-frame ending-frame';
    var endIcon = document.createElement('div');
    endIcon.style.cssText = 'width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: rgba(255,255,255,0.5);';
    endIcon.textContent = '→';
    endFrame.appendChild(endIcon);
    var endNum = document.createElement('span'); 
    endNum.className = 'frame-num';
    endNum.textContent = '→'; 
    endFrame.appendChild(endNum);
    
    // Add hover sound
    endFrame.addEventListener('mouseenter', function() {
      playSound(hoverSound);
    });
    
    endFrame.addEventListener('click', function(e) {
      e.stopPropagation();
      // Play click sound
      playSound(tapSound);
      // Scroll to ending slide
      var endingSlideIndex = photos.length + heroOffset;
      window.scrollTo({ top: window.innerHeight * endingSlideIndex, behavior: 'smooth' });
    });
    peekFrames.appendChild(endFrame);
  }
  function updatePeekHighlight(idx) {
    var frames = peekFrames.querySelectorAll('.film-frame');
    var isMain = (currentCat === 'main');
    var currentIdx = (idx !== undefined) ? idx : activeIndex; // Use provided index or activeIndex
    for (var i = 0; i < frames.length; i++) {
      if (isMain) {
        frames[i].classList.toggle('current', i === currentIdx);
      } else {
        // frame 0 = back button, frame 1+ = photos
        frames[i].classList.toggle('current', i === currentIdx + 1);
      }
    }
  }

  // Peek strip: photo clicks handle navigation individually

  // Peek strip: show on scroll briefly or mouse near right edge
  var peekScrollTimer = null;
  function showPeekBriefly() {
    peekStrip.classList.add('visible');
    clearTimeout(peekScrollTimer);
    peekScrollTimer = setTimeout(function() {
      peekStrip.classList.remove('visible');
    }, 1200);
  }

  // Scroll-triggered navigation
  var scrollAccumulator = 0;
  var scrollThreshold = 40; // Safe value that works across mice/trackpads
  var lastScrollTime = Date.now();
  var scrollTimeout = null;
  var canScroll = true; // Cooldown flag

  window.addEventListener('wheel', function(e) {
    // If snapping is disabled, allow natural scrolling
    if (!snappingEnabled) return;
    
    // Prevent default scrolling so we can control it
    e.preventDefault();
    
    if (!canScroll) return; // Short cooldown active
    
    var now = Date.now();
    var timeDelta = now - lastScrollTime;
    lastScrollTime = now;
    
    // Accumulate scroll delta
    scrollAccumulator += e.deltaY;
    
    // Fast scroll detection: if scrolling fast, reduce threshold slightly
    var currentThreshold = timeDelta < 100 ? scrollThreshold * 0.7 : scrollThreshold;
    
    // Clear timeout - we're still scrolling
    clearTimeout(scrollTimeout);
    
    // Check if we've scrolled enough to change slides
    if (Math.abs(scrollAccumulator) >= currentThreshold) {
      
      var newTargetIndex = targetSlideIndex; // Use target, not activeIndex!
      if (scrollAccumulator > 0) {
        // Scroll down - go to next slide
        newTargetIndex = Math.min(targetSlideIndex + 1, slides.length - 1);
      } else {
        // Scroll up - go to previous slide
        newTargetIndex = Math.max(targetSlideIndex - 1, 0);
      }
      
      if (newTargetIndex !== targetSlideIndex) {
        // Play scroll sound when changing slides
        playSound(hoverSound);
        
        targetSlideIndex = newTargetIndex; // Update target
        // Update peek highlight immediately
        updatePeekHighlight(targetSlideIndex);
        // Update film highlight too if menu is open
        if (filmMenuOpen) updateFilmHighlight(targetSlideIndex);
        // Smooth scroll - can be interrupted by next scroll
        window.scrollTo({ top: window.innerHeight * targetSlideIndex, behavior: 'smooth' });
        
        // Short cooldown to prevent super fast scrolling
        canScroll = false;
        setTimeout(function() {
          canScroll = true;
        }, 180); // ~180ms = deliberate pacing
      }
      
      scrollAccumulator = 0;
    }
    
    // Reset accumulator if user stops scrolling
    scrollTimeout = setTimeout(function() {
      scrollAccumulator = 0;
    }, 200);
    
    showPeekBriefly();
  }, { passive: false });

  window.addEventListener('scroll', function() {
    showPeekBriefly();
  }, { passive: true });

  document.addEventListener('mousemove', function(e) {
    if (e.clientX > window.innerWidth * 0.92) {
      clearTimeout(peekScrollTimer);
      peekStrip.classList.add('visible');
    } else {
      peekStrip.classList.remove('visible');
    }
  });

  /* ══════ FILM MENU TOGGLE ══════ */
  function toggleFilmMenu() {
    filmMenuOpen = !filmMenuOpen;
    filmOvl.classList.toggle('open', filmMenuOpen);
    loremWindow.classList.toggle('open', filmMenuOpen);
    
    // Only toggle settings popup on desktop
    if (!isMobile) {
      settingsPopup.classList.toggle('open', filmMenuOpen);
    }
    
    searchBarContainer.classList.toggle('visible', filmMenuOpen);
    tabSub.textContent = filmMenuOpen ? 'tap to close' : 'tap to open menu';

    if (filmMenuOpen) {
      // Play open sound
      playSound(openSound);
      
      // Show film panels for any active category buttons
      document.querySelectorAll('.category-btn.active').forEach(function(btn) {
        var cat = btn.getAttribute('data-cat');
        var panel = document.getElementById('film-panel-' + cat);
        if (panel) panel.classList.add('active');
      });
      
    } else {
      // Play close sound
      playSound(closeSound);
      
      // Hide all film panels
      document.querySelectorAll('.film-panel').forEach(function(p) {
        p.classList.remove('active');
      });
    }
  }

  leatherTab.addEventListener('click', toggleFilmMenu);
  
  // Add hover sound to leather tab
  leatherTab.addEventListener('mouseenter', function() {
    playSound(hoverSound);
  });
  
  settingsBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    
    if (isMobile) {
      // On mobile: only toggle settings popup, not the menu
      settingsPopup.classList.toggle('open');
    } else {
      // On desktop: toggle full menu
      toggleFilmMenu();
    }
  });
  
  // Sound toggle button
  soundBtn.addEventListener('mouseenter', function() {
    playSound(hoverSound);
  });
  
  soundBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    soundsEnabled = !soundsEnabled;
    soundBtn.classList.toggle('muted', !soundsEnabled);
    playSound(tapSound);
  });
  
  filmBkdp.addEventListener('click', function() { if (filmMenuOpen) toggleFilmMenu(); });

  // Close settings popup on mobile when clicking outside
  document.addEventListener('click', function(e) {
    if (isMobile && settingsPopup.classList.contains('open')) {
      if (!settingsPopup.contains(e.target) && !settingsBtn.contains(e.target)) {
        settingsPopup.classList.remove('open');
      }
    }
  });

  // Search bar functionality - instant photo search + clickable tags
  searchBar.addEventListener('focus', function() {
    playSound(selectSound);
    // Show tag categories on focus
    if (!searchBar.value.trim()) {
      buildTagCategories();
      searchResults.classList.add('visible');
    }
  });
  
  searchBar.addEventListener('input', function(e) {
    // Play type sound on each character typed
    playSound(tapSound);
    
    var query = searchBar.value.toLowerCase().trim();
    
    if (!query) {
      // Empty search - show all tags
      buildTagCategories();
      searchResults.classList.add('visible');
    } else {
      // Show matching photos AND filtered tags
      showSearchResults(query);
    }
  });
  
  // Show both instant photo results and filtered tags
  function showSearchResults(query) {
    var matchedPhotos = [];
    
    // Split query into terms for AND search
    var terms = query.split(/\s+/).filter(function(t) { return t.length > 0; });
    
    // Search through ALL categories for photos
    for (var cat in categories) {
      var photos = categories[cat];
      
      for (var i = 0; i < photos.length; i++) {
        var p = photos[i];
        var searchText = buildSearchableText(p);
        
        // Check if ALL terms are present (AND logic)
        var matchesAll = true;
        for (var t = 0; t < terms.length; t++) {
          if (searchText.indexOf(terms[t]) === -1) {
            matchesAll = false;
            break;
          }
        }
        
        if (matchesAll) {
          matchedPhotos.push({ photo: p, index: i, category: cat });
        }
      }
    }
    
    // Build HTML with photos only (no tags when typing)
    var html = '';
    
    // Show photo results if any
    if (matchedPhotos.length > 0) {
      html += '<div class="tag-category">';
      html += '<div class="tag-category-title">' + matchedPhotos.length + ' photo' + (matchedPhotos.length === 1 ? '' : 's') + ' matching "' + query + '"</div>';
      html += '</div>';
      
      html += '<div class="search-thumbnails">';
      
      for (var i = 0; i < matchedPhotos.length; i++) {
        var result = matchedPhotos[i];
        var photo = result.photo;
        var photoIndex = result.index;
        var photoCat = result.category;
        
        html += '<div class="search-thumb" data-index="' + photoIndex + '" data-category="' + photoCat + '">';
        html += '<img src="' + thumbUrl(photo.base) + '" alt="' + photo.base + '" />';
        html += '<div class="search-thumb-number">' + photoCat + ' #' + (photoIndex + 1) + '</div>';
        html += '</div>';
      }
      
      html += '</div>';
    } else {
      // No matches - show message but no tags
      html += '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No photos match "' + query + '"</div>';
    }
    
    searchResults.innerHTML = html;
    searchResults.classList.add('visible');
    
    // Add click handlers to thumbnails
    addThumbnailHandlers();
  }
  
  // Close search results when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchBarContainer.contains(e.target)) {
      searchResults.classList.remove('visible');
    }
  });
  
  // Prevent page scroll when scrolling inside search results dropdown
  searchResults.addEventListener('wheel', function(e) {
    e.stopPropagation();
  }, { passive: true });
  
  // Build tag categories (for showing all tags or filtered tags)
  function buildTagCategories(filterQuery) {
    var html = buildTagCategoriesHTML(filterQuery);
    searchResults.innerHTML = html;
    searchResults.classList.add('visible');
    addTagHandlers();
  }
  
  // Build tag categories HTML
  function buildTagCategoriesHTML(filterQuery) {
    // Get all photos from all categories
    var allPhotos = [];
    for (var cat in categories) {
      allPhotos = allPhotos.concat(categories[cat]);
    }
    
    var tagGroups = extractTagGroups(allPhotos);
    
    // Filter tags if search query provided
    if (filterQuery) {
      for (var category in tagGroups) {
        tagGroups[category] = tagGroups[category].filter(function(tag) {
          return tag.value.toLowerCase().indexOf(filterQuery) !== -1;
        });
      }
    }
    
    var html = '';
    var categoryOrder = searchCategories;
    
    for (var i = 0; i < categoryOrder.length; i++) {
      var catName = categoryOrder[i];
      var tags = tagGroups[catName];
      
      if (tags && tags.length > 0) {
        html += '<div class="tag-category">';
        html += '<div class="tag-category-title">' + catName + '</div>';
        html += '<div class="tag-list">';
        
        for (var j = 0; j < tags.length; j++) {
          var tag = tags[j];
          html += '<div class="tag-item" data-category="' + catName + '" data-value="' + tag.value + '">';
          html += tag.value;
          html += '<span class="tag-count">(' + tag.count + ')</span>';
          html += '</div>';
        }
        
        html += '</div></div>';
      }
    }
    
    if (!html && filterQuery) {
      html = '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No tags match "' + filterQuery + '"</div>';
    }
    
    return html;
  }
  
  // Extract and group tags from photos
  function extractTagGroups(photos) {
    var groups = {
      'ISO': {},
      'Aperture': {},
      'Focal Length': {},
      'Shutter Speed': {},
      'Camera': {},
      'Lens': {},
      'Film Stock': {},
      'Place': {},
      'City': {},
      'Country': {},
      'Subject': {},
      'Developing': {},
      'Date': {}
    };
    
    for (var i = 0; i < photos.length; i++) {
      var p = photos[i];
      
      if (p.iso) groups['ISO'][p.iso] = (groups['ISO'][p.iso] || 0) + 1;
      if (p.aperture) groups['Aperture'][p.aperture] = (groups['Aperture'][p.aperture] || 0) + 1;
      if (p.focal) groups['Focal Length'][p.focal] = (groups['Focal Length'][p.focal] || 0) + 1;
      if (p.shutter) groups['Shutter Speed'][p.shutter] = (groups['Shutter Speed'][p.shutter] || 0) + 1;
      
      if (p.camera && cameras[p.camera]) {
        var camName = cameras[p.camera].name;
        groups['Camera'][camName] = (groups['Camera'][camName] || 0) + 1;
      }
      
      if (p.lens && lenses[p.lens]) {
        var lensName = lenses[p.lens].name;
        groups['Lens'][lensName] = (groups['Lens'][lensName] || 0) + 1;
      }
      
      if (p.stock) groups['Film Stock'][p.stock] = (groups['Film Stock'][p.stock] || 0) + 1;
      if (p.place) groups['Place'][p.place] = (groups['Place'][p.place] || 0) + 1;
      if (p.city) groups['City'][p.city] = (groups['City'][p.city] || 0) + 1;
      if (p.country) groups['Country'][p.country] = (groups['Country'][p.country] || 0) + 1;
      if (p.subject) groups['Subject'][p.subject] = (groups['Subject'][p.subject] || 0) + 1;
      if (p.developing) groups['Developing'][p.developing] = (groups['Developing'][p.developing] || 0) + 1;
      
      if (p.date) {
        var year = p.date.split('-')[0];
        if (year) groups['Date'][year] = (groups['Date'][year] || 0) + 1;
      }
    }
    
    // Convert to arrays with counts
    var result = {};
    for (var category in groups) {
      result[category] = [];
      for (var value in groups[category]) {
        result[category].push({ value: value, count: groups[category][value] });
      }
      result[category].sort(function(a, b) {
        return a.value.localeCompare(b.value);
      });
    }
    
    return result;
  }
  
  // Add click handlers to tags
  function addTagHandlers() {
    searchResults.querySelectorAll('.tag-item').forEach(function(tagEl) {
      tagEl.addEventListener('mouseenter', function() {
        playSound(hoverSound);
      });
      
      tagEl.addEventListener('click', function(e) {
        e.stopPropagation();
        
        var value = tagEl.getAttribute('data-value');
        
        // Type the tag text into search bar character by character
        typeIntoSearch(value);
      });
    });
  }
  
  // Type text into search bar with animation
  var typingInProgress = false;
  function typeIntoSearch(textToType) {
    if (typingInProgress) return; // Don't start new typing if already typing
    
    typingInProgress = true;
    
    // Get current search value
    var currentText = searchBar.value.trim();
    
    // Add space if there's already text
    var finalText = currentText ? currentText + ' ' + textToType : textToType;
    
    // Start from current position
    var startPos = currentText.length + (currentText ? 1 : 0);
    var currentPos = 0;
    
    // Clear search bar and set to current text
    searchBar.value = currentText ? currentText + ' ' : '';
    searchBar.focus();
    
    // Type character by character
    var typeInterval = setInterval(function() {
      if (currentPos < textToType.length) {
        searchBar.value += textToType[currentPos];
        currentPos++;
        
        // Play hover sound
        playSound(hoverSound);
        
        // Trigger input event to update search results
        var event = new Event('input', { bubbles: true });
        searchBar.dispatchEvent(event);
      } else {
        // Typing complete
        clearInterval(typeInterval);
        typingInProgress = false;
      }
    }, 100); // 100ms between characters for typing effect
  }
  
  // Show photos matching a specific tag
  function showPhotosForTag(category, value) {
    var matched = [];
    
    // Search through ALL categories
    for (var cat in categories) {
      var photos = categories[cat];
      
      for (var i = 0; i < photos.length; i++) {
        var p = photos[i];
        var matches = false;
        
        if (category === 'ISO' && p.iso === value) matches = true;
        if (category === 'Aperture' && p.aperture === value) matches = true;
        if (category === 'Focal Length' && p.focal === value) matches = true;
        if (category === 'Shutter Speed' && p.shutter === value) matches = true;
        if (category === 'Camera' && p.camera && cameras[p.camera] && cameras[p.camera].name === value) matches = true;
        if (category === 'Lens' && p.lens && lenses[p.lens] && lenses[p.lens].name === value) matches = true;
        if (category === 'Film Stock' && p.stock === value) matches = true;
        if (category === 'Place' && p.place === value) matches = true;
        if (category === 'City' && p.city === value) matches = true;
        if (category === 'Country' && p.country === value) matches = true;
        if (category === 'Subject' && p.subject === value) matches = true;
        if (category === 'Developing' && p.developing === value) matches = true;
        if (category === 'Date' && p.date && p.date.split('-')[0] === value) matches = true;
        
        if (matches) {
          matched.push({ photo: p, index: i, category: cat });
        }
      }
    }
    
    // Build results HTML
    var html = '<div class="tag-category">';
    html += '<div class="tag-category-title">' + category + ': ' + value + ' (' + matched.length + ' photo' + (matched.length === 1 ? '' : 's') + ')</div>';
    html += '</div>';
    
    if (matched.length > 0) {
      html += '<div class="search-thumbnails">';
      
      for (var i = 0; i < matched.length; i++) {
        var result = matched[i];
        var photo = result.photo;
        var photoIndex = result.index;
        var photoCat = result.category;
        
        html += '<div class="search-thumb" data-index="' + photoIndex + '" data-category="' + photoCat + '">';
        html += '<img src="' + thumbUrl(photo.base) + '" alt="' + photo.base + '" />';
        html += '<div class="search-thumb-number">' + photoCat + ' #' + (photoIndex + 1) + '</div>';
        html += '</div>';
      }
      
      html += '</div>';
    }
    
    searchResults.innerHTML = html;
    addThumbnailHandlers();
  }
  
  // Add click handlers to thumbnails
  function addThumbnailHandlers() {
    searchResults.querySelectorAll('.search-thumb').forEach(function(thumb) {
      thumb.addEventListener('mouseenter', function() {
        playSound(hoverSound);
      });
      
      thumb.addEventListener('click', function(e) {
        e.stopPropagation();
        playSound(tapSound);
        
        var index = parseInt(thumb.getAttribute('data-index'));
        var photoCat = thumb.getAttribute('data-category');
        
        // Close search
        searchResults.classList.remove('visible');
        searchBar.value = '';
        
        if (filmMenuOpen) {
          toggleFilmMenu();
        }
        
        // Switch to the photo's category if needed
        if (photoCat !== currentCat) {
          document.querySelectorAll('.cat-frame').forEach(function(c) { c.classList.remove('active'); });
          document.querySelector('.cat-frame[data-cat="' + photoCat + '"]').classList.add('active');
          buildSlides(photoCat);
        }
        
        // Calculate scroll position with correct hero offset
        var isMain = (photoCat === 'main');
        var heroOffset = isMain ? 1 : 0;
        var scrollTo = window.innerHeight * (index + heroOffset);
        
        // Navigate to photo
        window.scrollTo({ top: scrollTo, behavior: 'smooth' });
      });
    });
  }
  
  // Build searchable text from photo data
  function buildSearchableText(photo) {
    var text = [];
    
    // Add all fields
    if (photo.base) text.push(photo.base.toLowerCase());
    if (photo.focal) text.push(photo.focal.toLowerCase());
    if (photo.aperture) text.push(photo.aperture.toLowerCase());
    if (photo.iso) text.push(photo.iso.toLowerCase());
    if (photo.shutter) text.push(photo.shutter.toLowerCase());
    if (photo.stock) text.push(photo.stock.toLowerCase());
    if (photo.date) text.push(photo.date.toLowerCase());
    if (photo.place) text.push(photo.place.toLowerCase());
    if (photo.city) text.push(photo.city.toLowerCase());
    if (photo.country) text.push(photo.country.toLowerCase());
    if (photo.subject) text.push(photo.subject.toLowerCase());
    if (photo.developing) text.push(photo.developing.toLowerCase());
    if (photo.description) text.push(photo.description.toLowerCase());
    
    // Add lens data
    if (photo.lens && lenses[photo.lens]) {
      text.push(lenses[photo.lens].name.toLowerCase());
      text.push(lenses[photo.lens].extra.toLowerCase());
    }
    
    // Add camera data
    if (photo.camera && cameras[photo.camera]) {
      text.push(cameras[photo.camera].name.toLowerCase());
      text.push(cameras[photo.camera].extra.toLowerCase());
    }
    
    return text.join(' ');
  }

  // Category clicks
  document.querySelectorAll('.cat-frame').forEach(function(cf) {
    // Add hover sound
    cf.addEventListener('mouseenter', function() {
      playSound(hoverSound);
    });
    
    cf.addEventListener('click', function() {
      var cat = cf.getAttribute('data-cat');
      if (cat === currentCat) return;
      
      // Play click sound
      playSound(tapSound);
      
      document.querySelectorAll('.cat-frame').forEach(function(c) { c.classList.remove('active'); });
      cf.classList.add('active');
      buildSlides(cat);
    });
  });

  // New category buttons (below search bar)
  document.querySelectorAll('.category-btn').forEach(function(btn) {
    btn.addEventListener('mouseenter', function() {
      playSound(hoverSound);
    });
    
    btn.addEventListener('click', function() {
      var cat = btn.getAttribute('data-cat');
      var wasActive = btn.classList.contains('active');
      
      // Play click sound
      playSound(tapSound);
      
      if (wasActive) {
        // Close this cartridge
        btn.classList.remove('active');
        var panel = document.getElementById('film-panel-' + cat);
        if (panel) panel.classList.remove('active');
      } else {
        // Open this cartridge (don't close others, don't switch photos)
        btn.classList.add('active');
        var panel = document.getElementById('film-panel-' + cat);
        if (panel) panel.classList.add('active');
      }
    });
  });

  /* ══════ SETTINGS ══════ */

  document.querySelectorAll('.setting-btn').forEach(function(btn) {
    // Add hover sound
    btn.addEventListener('mouseenter', function() {
      playSound(hoverSound);
    });
    
    btn.addEventListener('click', function() {
      // Play tap sound
      playSound(tapSound);
      
      var setting = btn.getAttribute('data-setting');
      var val = btn.getAttribute('data-val');
      // Update active button in group
      btn.parentElement.querySelectorAll('.setting-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');

      if (setting === 'font') {
        document.documentElement.setAttribute('data-font', val);
      } else if (setting === 'fontsize') {
        document.documentElement.setAttribute('data-fontsize', val);
      } else if (setting === 'lang') {
        // placeholder
      } else if (setting === 'res') {
        currentRes = val;
        buildSlides(currentCat);
      } else if (setting === 'snapping') {
        snappingEnabled = (val === 'on');
        // Refresh all image states to apply new mode
        activateSlide(activeIndex);
      } else if (setting === 'sounds') {
        soundsEnabled = (val === 'on');
      }
    });
  });

  /* ══════ RESIZE HINT + CROP PREVIEW ══════ */
  var TOLERANCE = 0.06;

  function getTargetRatio() {
    if (activeIndex <= 0 || !slides[activeIndex]) return 3/2;
    var img = slides[activeIndex].querySelector('img.main-photo');
    if (!img) return 3/2;
    return (img.naturalWidth||3) / (img.naturalHeight||2);
  }

  function gcd(a,b) { return b===0?a:gcd(b,a%b); }
  function niceRatio(w,h) {
    var g = gcd(Math.round(w),Math.round(h));
    var rw = Math.round(w/g), rh = Math.round(h/g);
    if (rw>30||rh>30) {
      var r = w/h;
      var c = [[16,9],[16,10],[21,9],[4,3],[3,2],[2,3],[3,4],[1,1],[9,16]];
      for (var i=0;i<c.length;i++) { if(Math.abs(r-c[i][0]/c[i][1])<0.05) return c[i][0]+':'+c[i][1]; }
    }
    return rw+':'+rh;
  }

  function updateRatio() {
    // Hide on hero (main only)
    if (currentCat === 'main' && activeIndex === 0) {
      resizeGroup.classList.remove('visible');
      return;
    }
    var target = getTargetRatio();
    var ratio = window.innerWidth / window.innerHeight;
    var diff = ratio - target;
    if (Math.abs(diff) < TOLERANCE) {
      resizeGroup.classList.remove('visible');
      return;
    }
    resizeGroup.classList.add('visible');

    if (diff > 0) {
      hintLabel.innerHTML = 'shrink horizontally \u2194<br>or expand vertically \u2195';
    } else {
      hintLabel.innerHTML = 'expand horizontally \u2194<br>or shrink vertically \u2195';
    }

    updateCropPreview();
  }

  function updateCropPreview() {
    if (activeIndex <= 0 || !slides[activeIndex]) return;
    var img = slides[activeIndex].querySelector('img.main-photo');
    if (!img) return;
    var nw = img.naturalWidth||3, nh = img.naturalHeight||2;
    var vpW = window.innerWidth, vpH = window.innerHeight;
    var pr = nw/nh, vr = vpW/vpH;
    var box = sw * 0.07;

    var pW, pH;
    if (pr > 1) { pW = box; pH = box/pr; }
    else { pH = box; pW = box*pr; }

    var vW, vH;
    if (vr > pr) { vW = pW; vH = pW/vr; }
    else { vH = pH; vW = pH*vr; }

    var mW = Math.max(pW,vW), mH = Math.max(pH,vH);
    cropPreview.style.width = mW+'px';
    cropPreview.style.height = mH+'px';

    cropDimImg.src = img.src;
    cropBrightImg.src = img.src;

    var pL=(mW-pW)/2, pT=(mH-pH)/2;
    photoFullEl.style.width=pW+'px'; photoFullEl.style.height=pH+'px';
    photoFullEl.style.left=pL+'px'; photoFullEl.style.top=pT+'px';

    var vL=(mW-vW)/2, vT=(mH-vH)/2;
    vpCropEl.style.width=vW+'px'; vpCropEl.style.height=vH+'px';
    vpCropEl.style.left=vL+'px'; vpCropEl.style.top=vT+'px';

    cropBrightImg.style.width=pW+'px'; cropBrightImg.style.height=pH+'px';
    cropBrightImg.style.left=(pL-vL)+'px'; cropBrightImg.style.top=(pT-vT)+'px';

    photoRatioLbl.textContent = niceRatio(nw,nh) + ' photo';
    photoRatioLbl.style.left = pL+'px';
    photoRatioLbl.style.top = (pT - sw*0.01) + 'px';
  }

  // Hint label hover → show crop preview
  hintLabel.addEventListener('mouseenter', function() {
    resizeGroup.classList.add('show-preview');
  });
  hintLabel.addEventListener('mouseleave', function() {
    resizeGroup.classList.remove('show-preview');
  });

  /* ══════ PHOTO INFO HOVER ══════ */
  var months = ['january','february','march','april','may','june','july','august','september','october','november','december'];

  function setupInfoHovers() {
    document.querySelectorAll('.info-line.hoverable').forEach(function(line) {
      line.addEventListener('mouseenter', function() {
        line.classList.add('hovered');
        var ext = line.querySelector('.extra-text');
        if (ext) ext.textContent = line.getAttribute('data-ext');
        var info = line.closest('.photo-info');
        if (!info) return;
        var hoverType = line.getAttribute('data-hover');
        info.querySelectorAll('.hover-photo').forEach(function(img) {
          img.classList.toggle('show', img.getAttribute('data-for') === hoverType);
        });
      });
      line.addEventListener('mouseleave', function() {
        line.classList.remove('hovered');
        var info = line.closest('.photo-info');
        if (!info) return;
        info.querySelectorAll('.hover-photo').forEach(function(img) {
          img.classList.remove('show');
        });
      });
    });

    document.querySelectorAll('.date-line').forEach(function(line) {
      line.style.cursor = 'default';
      line.addEventListener('mouseenter', function() {
        var full = line.getAttribute('data-full'); // YYYY-MM-DD format
        var parts = full.split('-'); // ['2023', '03', '15']
        var year = parts[0];
        var m = parseInt(parts[1], 10) - 1; // month index (0-11)
        var day = parts[2];
        line.textContent = day + ' ' + months[m] + ' ' + year;
      });
      line.addEventListener('mouseleave', function() {
        line.textContent = line.getAttribute('data-year');
      });
    });
  }

  /* ══════ AUTO-HIDE UI ══════ */
  var uiElements = [];
  var hideTimeout = null;
  var isUIVisible = true;

  function initAutoHideUI() {
    // Get all UI elements that should auto-hide
    uiElements = [
      document.getElementById('counter'),
      document.getElementById('leather-tab'),
      document.getElementById('sound-btn'),
      document.getElementById('settings-btn'),
      document.getElementById('scroll-down'),
      document.getElementById('resize-group')
    ].concat(Array.from(document.querySelectorAll('.photo-info')))
     .concat(Array.from(document.querySelectorAll('.photo-description')))
     .concat(Array.from(document.querySelectorAll('.view-more-btn')));
    
    // Remove nulls
    uiElements = uiElements.filter(function(el) { return el !== null; });
  }

  function showUI() {
    if (!isUIVisible) {
      uiElements.forEach(function(el) {
        if (el) el.classList.remove('hidden');
      });
      isUIVisible = true;
    }
    
    // Clear existing timeout
    if (hideTimeout) {
      clearTimeout(hideTimeout);
    }
    
    // Set new timeout to hide UI after 2 seconds
    hideTimeout = setTimeout(function() {
      hideUI();
    }, 2000);
  }

  function hideUI() {
    uiElements.forEach(function(el) {
      if (el) el.classList.add('hidden');
    });
    isUIVisible = false;
  }

  // Track mouse movement
  document.addEventListener('mousemove', function() {
    showUI();
  });

  // Track any click/interaction
  document.addEventListener('click', function() {
    showUI();
  });

  // Track scroll
  document.addEventListener('scroll', function() {
    showUI();
  });

  // Track keyboard
  document.addEventListener('keydown', function() {
    showUI();
  });

  // Prevent photo descriptions from hiding when hovering over them
  document.addEventListener('DOMNodeInserted', function(e) {
    var target = e.target;
    if (target.classList && target.classList.contains('photo-description')) {
      target.addEventListener('mouseenter', function() {
        // Keep showing UI while hovering over description
        if (hideTimeout) {
          clearTimeout(hideTimeout);
        }
      });
      target.addEventListener('mouseleave', function() {
        // Resume auto-hide when leaving description
        showUI();
      });
    }
  });

  // Start with UI visible and set initial timeout
  setTimeout(function() {
    initAutoHideUI();
    showUI();
  }, 100);

  /* ══════ INIT ══════ */
  console.log('=== INITIALIZATION START ===');
  console.log('categories:', categories);
  console.log('heroPhotoUrls:', heroPhotoUrls);
  
  // buildCatSprockets(); // Removed - no categories strip anymore
  console.log('Skipped buildCatSprockets - no categories strip');
  
  buildSlides('main');
  console.log('buildSlides(main) complete');
  
  // Initialize all 3 film strips
  buildFilmFrames('main');
  console.log('buildFilmFrames(main) complete');
  
  buildFilmFrames('portraits');
  console.log('buildFilmFrames(portraits) complete');
  
  buildFilmFrames('landscapes');
  console.log('buildFilmFrames(landscapes) complete');
  
  console.log('=== INITIALIZATION COMPLETE ===');
})();
</script>
</body>
</html>