<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Track movies you watch with TMDB integration and Firebase">
	<meta name="theme-color" content="#0a0a0a">
	<title>Movie Tracker</title>
	<style>
		:root {
			--bg: #0a0a0a;
			--surface: #1a1a1a;
			--border: #333;
			--text: #e0e0e0;
			--text-dim: #999;
			--accent: #00ff88;
			--hover: #2a2a2a;
			color-scheme: dark;
		}
		
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
			max-width: 800px;
			margin: 0 auto;
			padding: 2rem 1rem;
			background: var(--bg);
			color: var(--text);
			line-height: 1.6;
		}
		
		h1, h2, h3 {
			font-weight: 500;
			margin-block: 1rem;
		}
		
		input, button {
			font-family: inherit;
			font-size: 0.95rem;
			padding: 0.5rem;
			margin: 0.25rem;
			background: var(--surface);
			color: var(--text);
			border: 1px solid var(--border);
			border-radius: 0.25rem;
		}
		
		input:focus {
			outline: 2px solid var(--accent);
			outline-offset: 2px;
		}
		
		button {
			cursor: pointer;
			transition: all 0.2s;
		}
		
		button:hover {
			background: var(--hover);
			border-color: var(--accent);
		}
		
		button:active {
			transform: translateY(1px);
		}
		
		a {
			color: var(--accent);
		}
		
		section {
			margin-block: 2rem;
		}
		
		.field-group {
			margin-block: 1rem;
		}
		
		label {
			display: block;
			margin-block-end: 0.25rem;
			color: var(--text-dim);
			font-size: 0.9rem;
		}
		
		.auth-section {
			padding: 1rem;
			background: var(--surface);
			border-radius: 0.25rem;
			text-align: center;
			margin-block: 2rem;
		}
		
		.user-info {
			display: flex;
			align-items: center;
			gap: 1rem;
			justify-content: center;
		}
		
		.user-info img {
			width: 32px;
			height: 32px;
			border-radius: 50%;
		}
		
		.search-container {
			position: relative;
		}
		
		.search-results {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 0.25rem;
			max-height: 300px;
			overflow-y: auto;
			display: none;
			z-index: 10;
			margin-block-start: 0.25rem;
		}
		
		.search-results.active {
			display: block;
		}
		
		.movie-result {
			padding: 0.75rem;
			cursor: pointer;
			border-block-end: 1px solid var(--border);
			transition: background 0.15s;
		}
		
		.movie-result:hover {
			background: var(--hover);
		}
		
		.movie-result:last-child {
			border-block-end: none;
		}
		
		.selected-movie {
			padding: 1rem;
			background: var(--surface);
			border: 1px solid var(--accent);
			border-radius: 0.25rem;
			margin-block: 1rem;
		}
		
		.stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 1rem;
			padding: 1rem;
			background: var(--surface);
			border-radius: 0.25rem;
			margin-block: 1.5rem;
		}
		
		.stat {
			text-align: center;
		}
		
		.stat-value {
			font-size: 1.5rem;
			color: var(--accent);
			font-variant-numeric: tabular-nums;
		}
		
		.stat-label {
			font-size: 0.9rem;
			color: var(--text-dim);
		}
		
		.movie-list {
			margin-block-start: 2rem;
		}
		
		.movie-entry {
			padding: 0.75rem;
			border-block-end: 1px solid var(--border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			transition: background 0.15s;
		}
		
		.movie-entry:hover {
			background: var(--surface);
		}
		
		.movie-date {
			color: var(--text-dim);
			font-size: 0.9rem;
		}
		
		.movie-info {
			flex: 1;
			margin-inline-start: 1rem;
		}
		
		.movie-runtime {
			color: var(--accent);
			font-size: 0.9rem;
		}
		
		.button-group {
			display: flex;
			gap: 0.5rem;
			flex-wrap: wrap;
		}
		
		.hidden {
			display: none !important;
		}
		
		.loading {
			opacity: 0.5;
			pointer-events: none;
		}
		
		@media (prefers-reduced-motion: no-preference) {
			* {
				scroll-behavior: smooth;
			}
		}
		
		@media (max-width: 640px) {
			body {
				padding: 1rem 0.75rem;
			}
			
			.button-group {
				flex-direction: column;
			}
			
			button {
				width: 100%;
			}
		}
	</style>
</head>
<body>
	<header>
		<h1>ðŸŽ¬ Movie Tracker</h1>
	</header>
	
	<main>
		<section class="auth-section" id="authSection">
			<div id="signedOut">
				<button onclick="signIn()">Sign in with Google</button>
			</div>
			<div id="signedIn" class="hidden">
				<div class="user-info">
					<img id="userPhoto" src="" alt="">
					<span id="userName"></span>
					<button onclick="signOut()">Sign Out</button>
				</div>
			</div>
		</section>
		
		<div id="appContent" class="hidden">
			<section aria-label="API Configuration">
				<div class="field-group">
					<label for="apiKey">TMDB API Key</label>
					<input 
						type="password" 
						id="apiKey" 
						placeholder="Enter your TMDB API key" 
						style="width: min(100%, 400px);"
						autocomplete="off"
					>
					<a href="https://www.themoviedb.org/settings/api" target="_blank" rel="noopener">Get free key â†’</a>
				</div>
			</section>
			
			<section aria-label="Add Movie">
				<div class="search-container">
					<div class="field-group">
						<label for="movieSearch">Search Movie</label>
						<input 
							type="search" 
							id="movieSearch" 
							placeholder="Start typing to search..." 
							onkeyup="searchMovies(this.value)"
							autocomplete="off"
							style="width: 100%;"
						>
						<div id="searchResults" class="search-results" role="listbox"></div>
					</div>
				</div>
				
				<div id="selectedMovie" class="selected-movie" style="display: none;" role="status"></div>
				
				<div class="field-group">
					<label for="date">Date Watched</label>
					<div class="button-group">
						<input type="date" id="date">
						<button onclick="addMovie()" disabled id="addButton">Add Movie</button>
					</div>
				</div>
			</section>
			
			<section aria-label="Statistics" class="stats" id="stats">
				<div class="stat">
					<div class="stat-value" id="totalMovies">0</div>
					<div class="stat-label">Movies</div>
				</div>
				<div class="stat">
					<div class="stat-value" id="totalHours">0</div>
					<div class="stat-label">Hours</div>
				</div>
				<div class="stat">
					<div class="stat-value" id="avgRuntime">0</div>
					<div class="stat-label">Avg Minutes</div>
				</div>
			</section>
			
			<section aria-label="Movie List" class="movie-list">
				<h2>Recently Watched</h2>
				<div id="movieList" role="list"></div>
			</section>
		</div>
	</main>
	
<script type="module">
	import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js';
	import { 
		getAuth, 
		signInWithPopup, 
		GoogleAuthProvider, 
		signOut as firebaseSignOut,
		onAuthStateChanged 
	} from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js';
	import { 
		getFirestore, 
		collection, 
		doc, 
		setDoc, 
		getDoc,
		onSnapshot,
		serverTimestamp 
	} from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js';
	
	// Firebase configuration
	const firebaseConfig = {
		apiKey: "AIzaSyA3bWSEx-nzs2Y8m0ymrt_Jy3Iz6Vazzg4",
		authDomain: "letterbox-fc48c.firebaseapp.com",
		projectId: "letterbox-fc48c",
		storageBucket: "letterbox-fc48c.firebasestorage.app",
		messagingSenderId: "822392983645",
		appId: "1:822392983645:web:044da40a064c7b70a8bdb4"
	};
	
	// Initialize Firebase
	const app = initializeApp(firebaseConfig);
	// If you plan to separate scripts later, replace above line with:
	// const app = window.firebaseApp;

	const auth = getAuth(app);
	const db = getFirestore(app);
	const provider = new GoogleAuthProvider();
	
	let currentUser = null;
	let movieData = { movies: [] };
	let selectedMovie = null;
	let searchTimeout = null;
	let unsubscribe = null;
	
	document.getElementById('date').valueAsDate = new Date();
	
	onAuthStateChanged(auth, (user) => {
		if (user) {
			currentUser = user;
			document.getElementById('signedOut').classList.add('hidden');
			document.getElementById('signedIn').classList.remove('hidden');
			document.getElementById('appContent').classList.remove('hidden');
			document.getElementById('userName').textContent = user.displayName;
			document.getElementById('userPhoto').src = user.photoURL || '';
			loadUserData();
			loadApiKey();
		} else {
			currentUser = null;
			document.getElementById('signedOut').classList.remove('hidden');
			document.getElementById('signedIn').classList.add('hidden');
			document.getElementById('appContent').classList.add('hidden');
			if (unsubscribe) {
				unsubscribe();
				unsubscribe = null;
			}
		}
	});
	
	window.signIn = async () => {
		try {
			await signInWithPopup(auth, provider);
		} catch (error) {
			console.error('Sign in error:', error);
			alert('Failed to sign in. Please try again.');
		}
	};
	
	window.signOut = async () => {
		try {
			await firebaseSignOut(auth);
			movieData = { movies: [] };
			updateDisplay();
		} catch (error) {
			console.error('Sign out error:', error);
		}
	};
	
	async function loadUserData() {
		if (!currentUser) return;
		const userDocRef = doc(db, 'users', currentUser.uid);
		unsubscribe = onSnapshot(userDocRef, (doc) => {
			if (doc.exists()) {
				const data = doc.data();
				movieData = data.movieData || { movies: [] };
				updateDisplay();
			}
		});
	}
	
	async function saveToFirestore() {
		if (!currentUser) return;
		try {
			const userDocRef = doc(db, 'users', currentUser.uid);
			await setDoc(userDocRef, {
				movieData: movieData,
				lastUpdated: serverTimestamp(),
				email: currentUser.email
			}, { merge: true });
		} catch (error) {
			console.error('Error saving to Firestore:', error);
		}
	}
	
	async function loadApiKey() {
		if (!currentUser) return;
		try {
			const settingsDoc = await getDoc(doc(db, 'users', currentUser.uid, 'settings', 'tmdb'));
			if (settingsDoc.exists()) {
				const data = settingsDoc.data();
				if (data.apiKey) {
					document.getElementById('apiKey').value = data.apiKey;
				}
			}
		} catch (error) {
			console.error('Error loading API key:', error);
		}
	}
	
	document.getElementById('apiKey').addEventListener('change', async (e) => {
		if (!currentUser) return;
		try {
			const settingsDocRef = doc(db, 'users', currentUser.uid, 'settings', 'tmdb');
			await setDoc(settingsDocRef, {
				apiKey: e.target.value,
				updatedAt: serverTimestamp()
			});
		} catch (error) {
			console.error('Error saving API key:', error);
		}
	});
	
	window.searchMovies = async (query) => {
		const resultsDiv = document.getElementById('searchResults');
		if (query.length < 2) {
			resultsDiv.classList.remove('active');
			return;
		}
		clearTimeout(searchTimeout);
		searchTimeout = setTimeout(async () => {
			const apiKey = document.getElementById('apiKey').value;
			if (!apiKey) {
				alert('Please enter your TMDB API key first');
				return;
			}
			try {
				const response = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(query)}`);
				if (!response.ok) throw new Error('API request failed');
				const data = await response.json();
				resultsDiv.innerHTML = '';
				if (data.results?.length > 0) {
					data.results.slice(0, 5).forEach(movie => {
						const movieDiv = document.createElement('div');
						movieDiv.className = 'movie-result';
						movieDiv.role = 'option';
						const year = movie.release_date ? new Date(movie.release_date).getFullYear() : 'Unknown';
						movieDiv.innerHTML = `<strong>${movie.title}</strong><span class="movie-date">${year}</span>`;
						movieDiv.onclick = () => selectMovie(movie);
						resultsDiv.appendChild(movieDiv);
					});
					resultsDiv.classList.add('active');
				}
			} catch (error) {
				console.error('Search failed:', error);
			}
		}, 300);
	};
	
	async function selectMovie(movie) {
		const apiKey = document.getElementById('apiKey').value;
		try {
			const response = await fetch(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${apiKey}`);
			if (!response.ok) throw new Error('Failed to fetch movie details');
			const fullMovie = await response.json();
			selectedMovie = {
				tmdb_id: fullMovie.id,
				title: fullMovie.title,
				runtime: fullMovie.runtime || 0,
				poster_path: fullMovie.poster_path,
				release_date: fullMovie.release_date
			};
			document.getElementById('selectedMovie').innerHTML = `âœ“ Selected: <strong>${selectedMovie.title}</strong> (${selectedMovie.runtime} minutes)`;
			document.getElementById('selectedMovie').style.display = 'block';
			document.getElementById('searchResults').classList.remove('active');
			document.getElementById('movieSearch').value = selectedMovie.title;
			document.getElementById('addButton').disabled = false;
		} catch (error) {
			console.error('Failed to fetch movie details:', error);
		}
	}
	
	window.addMovie = async () => {
		if (!selectedMovie) {
			alert('Please search and select a movie first');
			return;
		}
		const dateInput = document.getElementById('date').value;
		if (!dateInput) {
			alert('Please select a date');
			return;
		}
		const movieEntry = {
			...selectedMovie,
			watched_date: dateInput,
			added_timestamp: new Date().toISOString()
		};
		movieData.movies.push(movieEntry);
		await saveToFirestore();
		document.getElementById('movieSearch').value = '';
		document.getElementById('selectedMovie').style.display = 'none';
		document.getElementById('addButton').disabled = true;
		selectedMovie = null;
		updateDisplay();
	};
	
	window.updateDisplay = () => {
		const totalMovies = movieData.movies.length;
		const totalMinutes = movieData.movies.reduce((sum, m) => sum + (m.runtime || 0), 0);
		const totalHours = (totalMinutes / 60).toFixed(1);
		const avgRuntime = totalMovies > 0 ? Math.round(totalMinutes / totalMovies) : 0;
		document.getElementById('totalMovies').textContent = totalMovies;
		document.getElementById('totalHours').textContent = totalHours;
		document.getElementById('avgRuntime').textContent = avgRuntime;
		const movieList = document.getElementById('movieList');
		movieList.innerHTML = '';
		const sortedMovies = [...movieData.movies].sort((a, b) => 
			new Date(b.watched_date) - new Date(a.watched_date)
		);
		sortedMovies.forEach(movie => {
			const div = document.createElement('div');
			div.className = 'movie-entry';
			div.role = 'listitem';
			const date = new Date(movie.watched_date).toLocaleDateString('en-US', {
				month: 'short',
				day: 'numeric',
				year: 'numeric'
			});
			div.innerHTML = `
				<span class="movie-date">${date}</span>
				<span class="movie-info">${movie.title}</span>
				<span class="movie-runtime">${movie.runtime} min</span>
			`;
			movieList.appendChild(div);
		});
	};
	
	updateDisplay();
</script>
</body>
</html>