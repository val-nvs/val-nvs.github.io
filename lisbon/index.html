<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>lisbon subway entrances</title>
	
	<!-- Make page responsive on mobile -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	
	<link
		rel="stylesheet"
		href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
	/>
	<style>
		html, body {
			background: #000;
			height: 100%;
			width: 100%;
			margin: 0;
			padding: 0;
		}
		#map { height: 100%; width: 100%; }
	</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([38.715, -9.138], 16);

// Dark-pale basemap
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
	subdomains: 'abcd',
	maxZoom: 20
}).addTo(map);

// Create a dedicated pane for subway entrances
map.createPane('subwayEntrances');
map.getPane('subwayEntrances').style.zIndex = 650;

// Metro line colors
const lineColors = {
	'red': 'rgba(238, 43, 115, 0.2)',
	'blue': 'rgba(84, 136, 197, 0.2)',
	'yellow': 'rgba(253, 183, 19, 0.2)',
	'green': 'rgba(0, 168, 165, 0.2)'
};

// Overpass query
const query = `
[out:json][timeout:60];

// --- Step 1: fetch ALL subway entrances in Lisbon area
node["railway"="subway_entrance"](38.6,-9.3,38.9,-9.0)->.entrances;

// --- Step 2: fetch ALL subway stations with station=subway tag
(
  node["railway"="station"]["station"="subway"](38.6,-9.3,38.9,-9.0);
  way["railway"="station"]["station"="subway"](38.6,-9.3,38.9,-9.0);
  relation["railway"="station"]["station"="subway"](38.6,-9.3,38.9,-9.0);
)->.stations;

// --- Step 3: fetch ALL metro line relations
relation["type"="route"]["route"="subway"](38.6,-9.3,38.9,-9.0)->.lines;

// --- Step 4: combine everything
(.entrances; .stations; .lines;);
out geom;
>;
out skel qt;
`;

fetch('https://overpass-api.de/api/interpreter', {
	method: 'POST',
	body: query
})
.then(res => res.json())
.then(data => {
	// FIRST PASS: Load only MAGENTA dots (subway entrances)
	const magentas = data.elements.filter(el => 
		el.type === "node" && el.lat && el.lon && el.tags?.railway === "subway_entrance"
	);
	
	magentas.forEach(el => {
		L.circleMarker([el.lat, el.lon], {
			radius: 10,
			fillColor: '#ff00ff',
			color: '#000',
			weight: 1,
			opacity: 1,
			fillOpacity: 0.6,
			pane: 'subwayEntrances'
		}).addTo(map)
		.bindPopup(el.tags?.name || el.id);
	});

	// SECOND PASS: Load everything else after magenta dots are done
	setTimeout(() => {
		data.elements.forEach(el => {
			// dots (subway stations)
			if(el.type === "node" && el.lat && el.lon && el.tags?.station === "subway") {
				let fillColor = '#000000';
				if(el.tags?.line) {
					fillColor = lineColors[el.tags.line] || fillColor;
				}
				
				L.circleMarker([el.lat, el.lon], {
					radius: 6,
					fillColor,
					color: '#000',
					weight: 1,
					opacity: 1,
					fillOpacity: 0.6,
					pane: 'subwayEntrances'
				}).addTo(map)
				.bindPopup(el.tags?.name || el.id);
			}
		});

		// Ways (station shapes)
		data.elements.forEach(el => {
			if(el.type === "way" && el.geometry) {
				let color = 'rgba(255,255,255,0.5)';
				let weight = 3;
				let opacity = 0.5;

				if(el.tags?.station === "subway") {
					color = 'rgba(255,255,255,0.5)';
					weight = 4;
					opacity = 0.7;
				} else if(el.tags?.line) {
					color = lineColors[el.tags.line] || color;
				}

				const latlngs = el.geometry.map(p => [p.lat, p.lon]);
				L.polyline(latlngs, {
					color,
					weight,
					opacity
				}).addTo(map)
				.bindPopup(el.tags?.name || el.id);
			}
		});

		// Relations (metro lines)
		data.elements.forEach(el => {
			if(el.type === "relation" && el.members) {
				el.members.forEach(m => {
					if(m.type === "way" && m.geometry) {
						let color = 'rgba(255,255,255,0.5)';
						let weight = 2;
						let opacity = 0.7;

						if(el.tags?.colour) {
							color = el.tags.colour;
							weight = 3;
							opacity = 0.8;
						} else if(el.tags?.station === "subway") {
							color = '#ffffff';
							weight = 3;
							opacity = 0.8;
						} else if(el.tags?.line) {
							color = lineColors[el.tags.line] || color;
						}

						const latlngs = m.geometry.map(p => [p.lat, p.lon]);
						L.polyline(latlngs, {
							color,
							weight,
							opacity
						}).addTo(map)
						.bindPopup(el.tags?.name || el.tags?.ref || el.id);
					}
				});
			}
		});
	}, 100);
});
</script>
</body>
</html>